#! ./dzref

iâ†"âŸ¨charGroups,Tokenize,ReadNum,CompileâŸ©"
âŸ¨charGroups,Tokenize,ReadNum,CompileâŸ© â† âŸ¨â€¢pathâˆ¾"src/c.bqn",iâŸ© â€¢EX â€¢pathâˆ¾"dzref"

chFâ†"+-Ã—Ã·â‹†âˆšâŒŠâŒˆ|Â¬âˆ§âˆ¨<>â‰ =â‰¤â‰¥â‰¡â‰¢âŠ£âŠ¢â¥Šâˆ¾â‰â†‘â†“â†•âŒ½â‰/â‹â’âŠâŠ‘âŠâŠ’âˆŠâ·âŠ”!"
bFâ€¿bMâ€¿bCâ€¿bSâ€¿bGâ€¿bBâ€¿bLâ€¿bOâ€¿bIâ€¿bUâ€¿bDâ€¿bNâ€¿bAâ€¿bPâ€¿bWâ†â‰Â¨ËœâŸœ(+`â‰ â†‘0âˆ¾âŠ¢)â‰ Â¨charGroups
Mâ†1âŠ¸âŠ‘(0âŠ¸â‰¤âˆ§>)-âŸœâŠ‘
viâ†+Â´â‰ Â¨9â†‘charGroups


# Targetting dzaima/BQN bytecode:
primsâ†âŸ¨
  +,-,Ã—,Ã·,â‹†,âˆš,âŒŠ,âŒˆ,|,Â¬,âˆ§,âˆ¨,<,>,â‰ ,=,â‰¤,â‰¥,â‰¡,â‰¢,âŠ£,âŠ¢,â¥Š,âˆ¾,â‰,â†‘,â†“,â†•,âŒ½,â‰,/,â‹,â’,âŠ,âŠ‘,âŠ,âŠ’,âˆŠ,â·,âŠ”,!
  Ë™,Ëœ,Ë˜,Â¨,âŒœ,â¼,Â´,Ë,`
  âˆ˜,â—‹,âŠ¸,âŸœ,âŒ¾,âŠ˜,â—¶,â‰,âš‡,âŸ
âŸ©
specialâ†<Ë˜âˆ˜â€¿2â¥Š"ğ•¤ğ•©ğ•¨ğ•£ğ•—ğ•˜"
DRunâ†{
  âŸ¨bc,o,blkâŸ© â† prims Compile ğ•©
  blk â†© {
    âŸ¨t,i,l,nâŸ©â†ğ•©
    sâ†(3Ã—i)â†“(tâŠ‘3â€¿5â€¿6)â†‘special
    âŸ¨tâŠ‘"fmd",i,l,sâˆ¾â¥ŠÂ¨'a'+â†•n-â‰ sâŸ©
  }Â¨blk
  â€¢COMP âŸ¨bc,o,âŸ¨âŸ©,blkâŸ©
}


# Targetting WebAssembly (very incomplete)
WParseâ†{
  aâ†ğ•©M(2â‰ËœâŠ‘bG)â‹„atâ†1âŒ½aâ‹„ğ•©/Ëœâ†©Â¬aâ‹„a/Ëœâ†©Â¬at
  lâ†â‰ ğ•©â‹„sepâ†ğ•©M bSâ‹„ğ•©â†©(bFâŠ‘âŠ¸+âŠ‘chFâŠ<'âŠ£')Â¨âŒ¾(sepâŠ¸/)ğ•©â‹„sepâˆ¨â†©ğ•©=2+âŠ‘bB
  oâ†ğ•©=âŠ‘bBâ‹„câ†ğ•©=1+âŠ‘bBâ‹„vâ†a-Ëœğ•©â‰¥viâ‹„fâ†Â¬oâˆ¨câˆ¨vâˆ¨sep
  naâ†(2Ã—sep)+fÃ—1+lâ†‘0âˆ¾câˆ¨v
  dâ†+`o-câ‹„feâ†(+`âŒ¾((â‹d)âŠ¸âŠ)o)âŠlâˆ¾(â‹âŠâŸœd)âŠ¸âŠ/c
  feâŒŠâ†©l-lâ†‘âŒ½âŒˆ`â†•âˆ˜â‰ âŠ¸Ã—âŒ½1âˆ¾Ëœsep
  selâ†Â¬âˆ˜âŠâŸœ(oâˆ¨c)âŠ¸/â‹((fÃ—fe)âŒˆâ†•l)-+`f-lâ†‘/â¼âˆ§f/fe
  selâŠ¸âŠÂ¨ğ•©â€¿na
}

Baseâ†{+âŸœ(ğ•¨âŠ¸Ã—)Â´ğ•©}
Enc2â†{2|âŒŠâˆ˜Ã·âŸœ2âŸ(â†•ğ•¨)ğ•©}

Hexâ†16 BaseâŸœâŒ½ (âˆ¾"0A"+âŸœâ†•Â¨10â€¿6)âŠ¸âŠ

GenF64â†{
  0:8â¥Š0;
  lâ†2(âŒŠâ‹†â¼)ğ•©
  (Hex"44")âˆ¾2 BaseË˜8â€¿8â¥Šâˆ¾âŸ¨Â¯52â†‘(0âŒˆl)Enc2ğ•©,11 Enc2 1023+l,â¥Š0âŸ©
}
MakeTabâ†{{âŠ‘âˆ˜(âˆ¾âŸœ0)Â¨Â¯1â†“(chFâŠğ•¨)âŠ”â—‹(âˆ¾âŸœ(â‰ chF))ğ•©}â—‹âˆ¾âŸœ(â¥ŠÂ¨âˆ˜â¥ŠÂ¨)Ëâ‰(2(Ã·Ëœâˆ¾âŠ£)â‰¢)âŠ¸â¥Šğ•©}
tab1â†MakeTabâŸ¨
  "âŠ£âŠ¢"     , 2â¥Š<âŸ¨âŸ©
  "|-âŒˆâŒŠâˆš"  , (Hex"99")+(â†•4)âˆ¾6
  "Ã·"      , <(Hex"10")âˆ¾0
  "Â¬"      , <âˆ¾â¥ŠÂ¨âŸ¨Hex"9A",GenF64 1,Hex"A0"âŸ©
âŸ©
tab2â†MakeTabâŸ¨
  "âŠ£"      , Hex"1A"
  "+-Ã—Ã·âŒŠâŒˆâˆ§", (Hex"A0")+(â†•6)âˆ¾2
  "Â¬"      , <âˆ¾â¥ŠÂ¨âŸ¨Hex"A1",GenF64 1,Hex"A0"âŸ©
  "âˆ¨"      , <(Hex"10")âˆ¾1
âŸ©
fntabâ†â‰(0Â¨tab1)âˆ¾tab1â‰tab2
f64â†127-3

GenFnâ†{
  âŸ¨t,r,nVar,litsâŸ©â†Tokenizeğ•©
  nLocâ†nVar-ğ•¨âŠ¢0
  tâŠËœâ†©â‹+`-Ë(2â€¿3+âŠ‘bB)=âŒœt
  ndâ†+Â´câ†t=3+âŠ‘bB
  tâ†©((vi+nVar+â‰ lits)+â†•âˆ˜â‰ )âŒ¾(câŠ¸/)t
  âŸ¨a,naâŸ©â†WParse t
  opsâ†â¥Šâˆ¾âŸ¨
    âˆ¾âŸœ(0â¥ŠËœ3âˆ¾Ëœvi-â‰ )fntab
    â‰(HexÂ¨"20"â€¿"22"â€¿"21")âˆ¾âŒœâ†•nVar
    âŠ£âŒœâŸœ(â†•3)(GenF64âˆ˜ReadNumÂ¨lits)âˆ¾(Hex"10")âˆ¾Â¨3+â†•nd
  âŸ©
  (((â‰ âˆ¾âˆ¾)âŸ¨nLocâˆ¾f64âŸ©)âˆ¾(Hex"0B")âˆ¾Ëœâˆ¾)Â¨((âŠ¢-ËœÂ¬Ã—+`)a=2+âŠ‘bB)âŠ”(na+3Ã—a)âŠops
}

Genâ†{
  LEBâ†{0:â¥Š0;128âŠ¸+âŒ¾(Â¯1âŠ¸â†“) 2 BaseË˜ (âˆ¨`âŒ¾âŒ½âˆ¨ËË˜)âŠ¸/ 10â€¿7(âŠ£â¥ŠÃ—Â´âŠ¸â†‘) 64 Enc2 ğ•©}
  Câ†LEBâˆ˜â‰ âŠ¸âˆ¾
  Sâ†âˆ¾âŸœC
  Vâ†â‰ âˆ¾âˆ¾
  Iâ†C-âŸœ@
  tâ€¿nâ€¿bâ†ğ•©
  âˆ¾âŸ¨
   0âˆ¾("asm"-@)âˆ¾4â†‘1
   1 S V (96âˆ¾âŸœâˆ¾CÂ¨)Â¨t
   3 S V â¥ŠÂ¨â†•â‰ b
   7 S V â¥Š<"fn"IâŠ¸(âŠ£âˆ¾0âˆ¾âŠ¢)n
  10 S V CÂ¨ b
  âŸ©
}

rcpâ†1 GenFn "1Ã·x"
or â†2 GenFn "(w+x)-wâˆ§x"
WCompileâ†{
  bodyâ†GenFn ğ•©
  fâ†âŸ¨rcp,or,bodyâŸ©
  Gen âŸ¨(â‰ Â¨f)/(1â€¿2â€¿0âˆ¾Â¨1)â¥ŠÂ¨Â¨f64 â‹„ 2 â‹„ âˆ¾fâŸ©
}
