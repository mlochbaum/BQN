#!/usr/bin/env bqn

âŠ”â†©((â†•1+(>âŒˆÂ´))=Â¨<)âˆ˜âŠ£ /Â¨âŸœ< â†•âˆ˜â‰ â âŠ¢
â·â†©âˆª

Baseâ†{+âŸœ(ğ•¨âŠ¸Ã—)Â´âŒ½ğ•©}
Enc2â†{ğ•¨â¥Š2(|âˆ¾Ëœ(ğ•¨-1)Enc2âŒŠâˆ˜Ã·Ëœ)âŸ(0<ğ•¨)ğ•©}

lfâ€¿tabâ†â€¢UCS 10â€¿9
charSetâ†âˆ¾charGroupsâ†âŸ¨
  "â"                   â Remark
  â€¢d â +âŸœ(â†•10)âŒ¾â€¢UCS'0'  â Digit
  "Â¯.Ï€âˆ"                â Numeric
  "_"âˆ¾' '(âŠ¢âˆ¾+)âŒ¾â€¢UCSâ€¢a   â Alphabetic
  chFâ†"+-Ã—Ã·â‹†âˆšâŒŠâŒˆ|Â¬âˆ§âˆ¨<>â‰ =â‰¤â‰¥â‰¡â‰¢âŠ£âŠ¢â¥Šâˆ¾â‰â†‘â†“â†•âŒ½â‰/â‹â’âŠâŠ‘âŠâŠ’âˆŠâ·âŠ”" â Function
  "ËœË˜Â¨âŒœâ¼Â´`"             â Modifier
  "âˆ˜â—‹âŠ¸âŸœâŒ¾â‰âš‡âŸ"            â Composition
  "ğ•¨ğ•ğ•©ğ•ğ•—ğ”½ğ•˜ğ”¾"            â Parameter
  " "âˆ¾tab               â Whitespace
  lfâˆ¾"â‹„,"               â Separator
  "â†â†©â†’"                 â Gets
  "(){}âŸ¨âŸ©"              â Bracket
  "â€¿"                   â Ligature
  "'"""                 â Quote
âŸ©
bRâ€¿bDâ€¿bNâ€¿bAâ€¿bFâ€¿bMâ€¿bCâ€¿bPâ€¿bWâ€¿bSâ€¿bGâ€¿bBâ€¿bLâ€¿bQâ†â†•âˆ˜â‰ âŒ¾âˆ¾charGroups
viâ†â‰ charSet

Tokenizeâ†{
  argsâ†charSetâŠ¸âŠÂ¨ğ•¨â‹„câ†charSetâŠğ•©
  c(/Ëœ)â†©Â¬<â—‹(âŒˆ`â†•âˆ˜â‰ âŠ¸Ã—)Â´((âŠ‘bS)âˆ¾bR)=âŒœc
  wâ†(<Â´â‰ â†•0âˆ¾âŠ¢)lâ†câˆŠâˆ¾bDâ€¿bNâ€¿bA
  idâ†â·argsâˆ¾(bAâˆŠËœw/c)â’âŠ¸âŠiâ†(1-ËœlÃ—+`w)âŠ”c
  nvâ†>+Â´bAâˆŠËœâŠ‘Â¨id
  câ†©(wâˆ¨Â¬lâˆ¨câˆŠbW)/(vi+idâŠi)âŒ¾(wâŠ¸/)c
  c(/Ëœ)â†©Â¬(1âŒ¾âŠ‘1âŒ½1âŒ¾âŠ‘)âŠ¸âˆ§câˆŠbS
  âŸ¨c,nv,nv-â‰ args,nvâ†“idâŸ©
}

Parseâ†{
  aâ†ğ•©âˆŠ(2â†‘bG)â‹„atâ†1âŒ½aâ‹„ğ•©(/Ëœ)â†©Â¬aâ‹„a(/Ëœ)â†©Â¬at
  lâ†â‰ ğ•©â‹„sepâ†ğ•©âˆŠbSâ‹„ğ•©â†©(bFâŠ‘ËœchFâŠ<'âŠ£')Â¨âŒ¾(sepâŠ¸/)ğ•©
  oâ†ğ•©=0âŠ‘bBâ‹„câ†ğ•©=1âŠ‘bBâ‹„vâ†a-Ëœğ•©â‰¥viâ‹„fâ†Â¬oâˆ¨câˆ¨vâˆ¨sep
  naâ†(2Ã—sep)+fÃ—1+lâ†‘0âˆ¾câˆ¨v
  eâ†/câ‹„dâ†+`o-c
  edâ†eâŠdâ‹„bâ†(â‹â‹ed)âŠ(â‹âŠâŸœd)âŠ¸âŠ/o
  gâ†âŠ”edâˆ¾0â‹„sâ†e-(eâŠËœâˆ¾(â‹âŠâŠ£)Â¨Â´â‰2â†•g)âŒ¾((âˆ¾1â†“g)âŠ¸âŠ)lÂ¨e
  feâ†fÃ—(l-1)++`(-âŠ¸â‰s)âŒ¾((eâ‰b)âŠ¸âŠ)lâ¥Š0
  feâŒŠâ†©(l-1)-lâ†‘(âŒˆ`â†•âˆ˜â‰ âŠ¸Ã—)âŒ¾âŒ½1âˆ¾Ëœsep
  iaâ†+`lâ†‘0âˆ¾f-lâ†‘/â¼âˆ§f/fe
  selâ†Â¬âˆ˜âŠâŸœ(oâˆ¨c)âŠ¸/â‹(feâŒˆâ†•l)-ia
  selâŠ¸âŠÂ¨ğ•©â€¿na
}

Hexâ†16 Base (â€¢dâˆ¾"ABCDEF")âŠ¸âŠ

ReadNumâ†10 Base bDâŠ¸âŠ
GenF64â†{
  ğ•©=0:8â¥Š0
  lâ†2(âŒŠâ‹†â¼)ğ•©
  (Hex"44")âˆ¾2 BaseË˜âŒ½8â€¿8(âŠ£â¥ŠÃ—Â´âŠ¸â†‘)âˆ¾âŸ¨â¥Š0,11 Enc2 1023+l,(0âŒˆl)Enc2ğ•©âŸ©
}
MakeTabâ†{{(â‰ chF)â†‘âŠ‘Â¨(chFâŠğ•¨)âŠ”ğ•©}â—‹âˆ¾âŸœ(â¥ŠÂ¨âˆ˜â¥ŠÂ¨)Â´â‰(2(Ã·Ëœâˆ¾âŠ£)â‰¢)âŠ¸â¥Šğ•©}
tab1â†MakeTabâŸ¨
  "âŠ£âŠ¢"     , 2â¥Š<âŸ¨âŸ©
  "|-âŒˆâŒŠâˆš"  , (Hex"99")+(â†•4)âˆ¾6
  "Ã·"      , <(Hex"10")âˆ¾1
  "Â¬"      , <âˆ¾â¥ŠÂ¨âŸ¨Hex"9A",GenF64 1,Hex"A0"âŸ©
âŸ©
tab2â†MakeTabâŸ¨
  "âŠ£"      , Hex"1A"
  "+-Ã—Ã·âŒŠâŒˆâˆ§", (Hex"A0")+(â†•6)âˆ¾2
  "Â¬"      , <âˆ¾â¥ŠÂ¨âŸ¨Hex"A1",GenF64 1,Hex"A0"âŸ©
  "âˆ¨"      , <(Hex"10")âˆ¾2
âŸ©
f64â†127-3

GenFnâ†{
  âŸ¨âŸ©GenFnğ•©;
  âŸ¨tok,nVar,nLoc,numsâŸ©â†ğ•¨Tokenizeğ•©
  âŸ¨x,naâŸ©â†Parse tok
  loadâ†((Hex"20")âˆ¾Â¨â†•nVar)âˆ¾GenF64âˆ˜ReadNumÂ¨nums
  fnsâ†{
    (ğ•©-vi)âŠ‘load
  }â€¿{
    ğ•©â‰¥vi:(Hex"22")âˆ¾ğ•©-vi
    (ğ•©-âŠ‘bF)âŠ‘tab1
  }â€¿{
    (ğ•©-âŠ‘bF)âŠ‘tab2
  }
  ((â‰ âˆ¾âˆ¾)âŸ¨nLocâˆ¾f64âŸ©)âˆ¾(Hex"0B")âˆ¾Ëœâˆ¾naâŠ‘âŸœfnsâŠ¸{ğ•ğ•©}Â¨x
}

Genâ†{
  LEBâ†{0â‰¡ğ•©:â¥Š0â‹„128âŠ¸+âŒ¾(Â¯1âŠ¸â†“) 2 Base âŒ½â‰ (âˆ¨`âŒ¾âŒ½âˆ¨Â´Ë˜)âŠ¸/ 10â€¿7(âŠ£â¥ŠÃ—Â´âŠ¸â†‘) âŒ½64 Enc2 ğ•©}
  Câ†LEBâˆ˜â‰ âŠ¸âˆ¾
  Sâ†âˆ¾âŸœC
  Vâ†â‰ âˆ¾âˆ¾
  Iâ†Câˆ˜â€¢UCS
  tâ€¿nâ€¿bâ†ğ•©
  âˆ¾âŸ¨
   0âˆ¾(â€¢UCS"asm")âˆ¾4â†‘1
   1 S V (96âˆ¾âŸœâˆ¾CÂ¨)Â¨t
   3 S V â¥ŠÂ¨â†•â‰ b
   7 S V IâŠ¸(âŠ£âˆ¾0âˆ¾âŠ¢)Â¨âŸœ(â†•âˆ˜â‰ )n
  10 S V CÂ¨ b
  âŸ©
}

Compileâ†{
  bodyâ†GenFn ğ•©
  rcpâ†âŸ¨"x"âŸ© GenFn "1Ã·x"
  orâ†âŸ¨"w","x"âŸ© GenFn "(w+x)-wâˆ§x"
  Gen âŸ¨âŸ¨0â€¿1,1â€¿1,2â€¿1âŸ©/Â¨Â¨f64 â‹„ â¥Š<"fn" â‹„ âŸ¨body,rcp,orâŸ©âŸ©
}
