#! ./dzref

nlâ€¿tabâ†â€¢UCS 10â€¿9
charSetâ†âˆ¾charGroupsâ†âŸ¨
  chFâ†"+-Ã—Ã·â‹†âˆšâŒŠâŒˆ|Â¬âˆ§âˆ¨<>â‰ =â‰¤â‰¥â‰¡â‰¢âŠ£âŠ¢â¥Šâˆ¾â‰â†‘â†“â†•âŒ½â‰/â‹â’âŠâŠ‘âŠâŠ’âˆŠâ·âŠ”!" # Function
  "ËœË˜Â¨âŒœâ¼Â´Ë`"            # Modifier
  "âˆ˜â—‹âŠ¸âŸœâŒ¾âŠ˜â—¶â‰âš‡âŸ"          # Composition
  nlâˆ¾"â‹„,"               # Separator
  "â†â†©â†’"                 # Gets
  "(){}âŸ¨âŸ©"              # Bracket
  "â€¿"                   # Ligature
  "Â·"                   # nOthing
  Â¯1âŠË˜10â€¿2â¥Š"ğ•Šğ•ğ•ğ”½ğ”¾ğ•¤ğ•©ğ•¨ğ•—ğ•˜" # Input (ğ•£ pending; â„ not allowed)
  â€¢d # +âŸœ(â†•10)âŒ¾â€¢UCS'0'  # Digit
  "Â¯.Ï€âˆ"                # Numeric
  "_"âˆ¾Ëœ' '(+âˆ¾âŠ¢)âŒ¾â€¢UCSâ€¢a  # Alphabetic
  1â†‘"ğ•¨"                 # Prefix for input (hack around UTF-16)
  " "âˆ¾tab               # Whitespace
# #'" eliminated during tokenization
âŸ©
bFâ€¿bMâ€¿bCâ€¿bSâ€¿bGâ€¿bBâ€¿bLâ€¿bOâ€¿bIâ€¿bDâ€¿bNâ€¿bAâ€¿bPâ€¿bWâ†âŠ”/â‰ Â¨charGroups
viâ†+Â´â‰ Â¨9â†‘charGroups
charRoleâ†((vi-â‰ bI)â†‘/0âˆ¾â‰ Â¨3â†‘charGroups)âˆ¾(5/âŒ½â†•2)âˆ¾0
specialâ†<Ë˜6â€¿2â¥Š"ğ•¤ğ•©ğ•¨ğ•£ğ•—ğ•˜"
spdâ†â¥Šâ‰3â€¿0â†“âŒœâ†‘âŸœspecialâŒœ3â€¿5â€¿6

Tokenizeâ†{
  râ†ğ•©='#'â‹„sâ†/(â‰ â†‘2âŠ¸â†“)âŠ¸âˆ§ğ•©='''â‹„dâ†/ğ•©='"'
  gâ†â‹qâ†âˆ¾âŸ¨  sâ‹„Â¯1â†“dâ‹„/râŸ© â‹„qâ†©gâŠq
  eâ† gâŠâˆ¾âŸ¨2+sâ‹„ 1â†“dâ‹„(âŠ¢-Â¯1â†“0âˆ¾âŠ¢)âˆ˜âŠâŸœ(0âˆ¾+`r)âŠ¸//(ğ•©=nl)âˆ¾1âŸ©
  Seâ†{(âŠËœğ•¨)Se 1Â¨âŒ¾((ğ•©/ğ•¨)âŠ¸âŠ)ğ•©}âŸ{0=âŠ‘âŒ½ğ•©}
  stâ†Â¯1â†“SeâŸœ(1â†‘Ëœâ‰ )âˆ¾âŸœâ‰ qâ‹eâ‹„bâ†st/qâˆ¾Ë˜e
  ToIâ†Â¯1â†“Â·/â¼(â‰ ğ•©)âˆ¾Ëœâ¥Šâ‹„fâ†Â¬â‰ `ToI b
  cbâ†(Â¬(st/q)âŠr)/b
  luâ†â·litâ†ğ•©âŠ”Ëœ1-Ëœ(+`ToIâŠ‘Ë˜cb)Ã—â‰ `ToI cb
  clâ†f/ToIâŠ‘âˆ˜âŒ½Ë˜cb

  câ†charSetâŠf/ğ•©
  wâ†(â‰ â†‘0âˆ¾âŠ¢)âŠ¸<lâ†câˆŠâˆ¾bDâ€¿bNâ€¿bA
  iâ†(1-ËœlÃ—+`w)âŠ”c
  naâ†â‰ â€¢aâ‹„usâ†Â¯1âŠ‘bA
  inâ†na(âŠ¢-âŠ£Ã—+âŸœ(âŠ‘bA)âŠ¸â‰¤)usâŠ¸â‰ âŠ¸/Â¨i
  idâ†â·(bAâˆŠËœw/c)â’âŠ¸âŠinâ‹„nvâ†+Â´bAâˆŠËœâŠ‘Â¨id

  câ†©(wâˆ¨Â¬lâˆ¨câˆŠbPâˆ¾bW)/(vi+idâŠin)âŒ¾(wâŠ¸/)(vi+(â‰ id)+luâŠlit)âŒ¾(clâŠ¸/)c
  c/Ëœâ†©Â¬(â‰ â†‘1âˆ¾(câˆŠ2â€¿4âŠbB)âˆ¨âŠ¢)âŠ¸âˆ§câˆŠbSâ‹„c/Ëœâ†©Â¬(1â†“1âˆ¾ËœcâˆŠ3â€¿5âŠbB)âˆ§câˆŠbS
  tiâ†(us=Â¯1âŠ¸âŠ‘Â¨i)(âŠ¢+âˆ§âŸœ(2âŠ¸=))0âŒˆnaâŒŠâˆ˜Ã·Ëœ(âŠ‘bA)-ËœâŠ‘Â¨i
  tâ†tiâŒ¾(((0âŠ¸â‰¤âˆ§<âŸœ(â‰ id))c-vi)âŠ¸/)(viâŒŠc)âŠcharRole
  c+â†©5Ã—câˆŠ5â†‘bI
  âŸ¨c,t,nv,(nvâ†“id)âˆ¾luâŸ©
}

Parseâ†{
  aâ†ğ•©âˆŠ(2â†‘bG)â‹„atâ†1âŒ½aâ‹„ğ•©/Ëœâ†©Â¬aâ‹„a/Ëœâ†©Â¬at
  lâ†â‰ ğ•©â‹„sepâ†ğ•©âˆŠbSâ‹„ğ•©â†©(bFâŠ‘Ëœâ¥ŠchFâŠ<'âŠ£')Â¨âŒ¾(sepâŠ¸/)ğ•©â‹„sepâˆ¨â†©ğ•©=2âŠ‘bB
  oâ†ğ•©=0âŠ‘bBâ‹„câ†ğ•©=1âŠ‘bBâ‹„vâ†a-Ëœğ•©â‰¥viâ‹„fâ†Â¬oâˆ¨câˆ¨vâˆ¨sep
  naâ†(2Ã—sep)+fÃ—1+lâ†‘0âˆ¾câˆ¨v
  dâ†+`o-câ‹„feâ†(+`âŒ¾((â‹d)âŠ¸âŠ)o)âŠlâˆ¾(â‹âŠâŸœd)âŠ¸âŠ/c
  feâŒŠâ†©l-lâ†‘âŒ½âŒˆ`â†•âˆ˜â‰ âŠ¸Ã—âŒ½1âˆ¾Ëœsep
  selâ†Â¬âˆ˜âŠâŸœ(oâˆ¨c)âŠ¸/â‹((fÃ—fe)âŒˆâ†•l)-+`f-lâ†‘/â¼âˆ§f/fe
  selâŠ¸âŠÂ¨ğ•©â€¿na
}

Baseâ†{+âŸœ(ğ•¨âŠ¸Ã—)Â´ğ•©}
Enc2â†{2|âŒŠâˆ˜Ã·âŸœ2âŸ(â†•ğ•¨)ğ•©}

Hexâ†16 BaseâŸœâŒ½ (â€¢dâˆ¾"ABCDEF")âŠ¸âŠ

ReadNumâ†{
  nâ€¿dâ€¿pâ€¿iâ†bN  # Â¯.Ï€âˆ
  Natâ†10 BaseâŸœâŒ½ -âŸœ(âŠ‘bD)
  Intâ†(n=âŠ‘)â—¶âŸ¨Nat,-Â·Nat 1âŠ¸â†“âŸ©
  Decâ†âŠâŸœ(<d)âŠ¸(Natâˆ˜â†‘ + Â·(0<â‰ )â—¶âŸ¨0,NatÃ·10â‹†â‰ âŸ©+âŸœ1âŠ¸â†“)
  Posâ†(âŠ‘pâ€¿iâŠâŠ)â—¶âŸ¨Ï€,âˆ,DecâŸ©
  eâ†âŠ‘ğ•©âŠcharSetâŠ<'e'
  mâ†(n=âŠ‘)â—¶âŸ¨Pos,-Â·Pos 1âŠ¸â†“âŸ©eâ†‘ğ•©
  ğ•©Ã—âŸœ(10â‹†Â·Int(e+1)â†“âŠ£)ËœâŸ(e<â‰ ğ•©)m
}
LitValâ†(âŠ‘"'"""âŠâŠ)â—¶âŸ¨1âŠ¸âŠ‘,1âŠ¸â†“,ReadNumâŸ©
GenF64â†{
  0:8â¥Š0;
  lâ†2(âŒŠâ‹†â¼)ğ•©
  (Hex"44")âˆ¾2 BaseË˜8â€¿8â¥Šâˆ¾âŸ¨Â¯52â†‘(0âŒˆl)Enc2ğ•©,11 Enc2 1023+l,â¥Š0âŸ©
}
MakeTabâ†{{âŠ‘âˆ˜(âˆ¾âŸœ0)Â¨Â¯1â†“(chFâŠğ•¨)âŠ”â—‹(âˆ¾âŸœ(â‰ chF))ğ•©}â—‹âˆ¾âŸœ(â¥ŠÂ¨âˆ˜â¥ŠÂ¨)Ëâ‰(2(Ã·Ëœâˆ¾âŠ£)â‰¢)âŠ¸â¥Šğ•©}
tab1â†MakeTabâŸ¨
  "âŠ£âŠ¢"     , 2â¥Š<âŸ¨âŸ©
  "|-âŒˆâŒŠâˆš"  , (Hex"99")+(â†•4)âˆ¾6
  "Ã·"      , <(Hex"10")âˆ¾0
  "Â¬"      , <âˆ¾â¥ŠÂ¨âŸ¨Hex"9A",GenF64 1,Hex"A0"âŸ©
âŸ©
tab2â†MakeTabâŸ¨
  "âŠ£"      , Hex"1A"
  "+-Ã—Ã·âŒŠâŒˆâˆ§", (Hex"A0")+(â†•6)âˆ¾2
  "Â¬"      , <âˆ¾â¥ŠÂ¨âŸ¨Hex"A1",GenF64 1,Hex"A0"âŸ©
  "âˆ¨"      , <(Hex"10")âˆ¾1
âŸ©
fntabâ†â‰(0Â¨tab1)âˆ¾tab1â‰tab2
f64â†127-3

GenFnâ†{
  âŸ¨t,r,nVar,litsâŸ©â†Tokenizeğ•©
  nLocâ†nVar-ğ•¨âŠ¢0
  tâŠËœâ†©â‹+`-Ë(2â€¿3âŠbB)=âŒœt
  ndâ†+Â´câ†t=3âŠ‘bB
  tâ†©((vi+nVar+â‰ lits)+â†•âˆ˜â‰ )âŒ¾(câŠ¸/)t
  âŸ¨a,naâŸ©â†Parse t
  opsâ†â¥Šâˆ¾âŸ¨
    âˆ¾âŸœ(0â¥ŠËœ3âˆ¾Ëœvi-â‰ )fntab
    â‰(HexÂ¨"20"â€¿"22"â€¿"21")âˆ¾âŒœâ†•nVar
    âŠ£âŒœâŸœ(â†•3)(GenF64âˆ˜ReadNumÂ¨lits)âˆ¾(Hex"10")âˆ¾Â¨3+â†•nd
  âŸ©
  (((â‰ âˆ¾âˆ¾)âŸ¨nLocâˆ¾f64âŸ©)âˆ¾(Hex"0B")âˆ¾Ëœâˆ¾)Â¨((âŠ¢-ËœÂ¬Ã—+`)a=2âŠ‘bB)âŠ”(na+3Ã—a)âŠops
}

Genâ†{
  LEBâ†{0:â¥Š0;128âŠ¸+âŒ¾(Â¯1âŠ¸â†“) 2 BaseË˜ (âˆ¨`âŒ¾âŒ½âˆ¨ËË˜)âŠ¸/ 10â€¿7(âŠ£â¥ŠÃ—Â´âŠ¸â†‘) 64 Enc2 ğ•©}
  Câ†LEBâˆ˜â‰ âŠ¸âˆ¾
  Sâ†âˆ¾âŸœC
  Vâ†â‰ âˆ¾âˆ¾
  Iâ†Câˆ˜â€¢UCS
  tâ€¿nâ€¿bâ†ğ•©
  âˆ¾âŸ¨
   0âˆ¾(â€¢UCS"asm")âˆ¾4â†‘1
   1 S V (96âˆ¾âŸœâˆ¾CÂ¨)Â¨t
   3 S V â¥ŠÂ¨â†•â‰ b
   7 S V â¥Š<"fn"IâŠ¸(âŠ£âˆ¾0âˆ¾âŠ¢)n
  10 S V CÂ¨ b
  âŸ©
}

rcpâ†1 GenFn "1Ã·x"
or â†2 GenFn "(w+x)-wâˆ§x"
Compileâ†{
  bodyâ†GenFn ğ•©
  fâ†âŸ¨rcp,or,bodyâŸ©
  Gen âŸ¨(â‰ Â¨f)/(1â€¿2â€¿0âˆ¾Â¨1)â¥ŠÂ¨Â¨f64 â‹„ 2 â‹„ âˆ¾fâŸ©
}


# Targetting dzaima/BQN bytecode:

LEBv â† {
  bâ†128
  â·lâ†âŒŠbâ‹†â¼1âŒˆğ•©
  oâ†â‹â‹âŠ’/1+l
  oâŠl{fâ†Ã—ğ•¨â‹„(ğ•¨-1)(bâŠ¸(Ã—âŸœf+|)âˆ¾ğ•ŠâŸœ(âŒŠÃ·âŸœb)â—‹(fâŠ¸/))âŸ(âˆ¨Â´f)ğ•©}ğ•©
}

DParse â† {nvâ€¿rğ•Šğ•©:
  gâ†â‹+`pâ†bB(âŠ£(â‰ âŠ¸>Ã—Â¯1â‹†2|âŠ¢)âŠ)ğ•©â‹„brâ†pÃ—ğ•©âˆŠ2â€¿3âŠbB
  slâ†1âŠ¸âŒ½âŠ¸âˆ¨ğ•©âˆŠbLâ‹„srâ†Â¯1âŠ¸âŒ½âŒ¾(gâŠ¸âŠ)slâ‹„saâ†slâˆ¨sr
  gâŠËœâ†©â‹gâŠslâ‹„rÃ—â†©Â¬saâ‹„oâ†p>0
  r+â†©(sa<ğ•©=1âŠ‘bB)(âŠ£âˆ§Â¬âŠ¸âˆ¨=â—‹(âŒˆ`(1+â†•âˆ˜â‰ )âŠ¸Ã—)âŠ¢)(Â¯1âŠ¸âŒ½âŒ¾(gâŠ¸âŠ)3=r)âˆ¨1â‰¤r
  revâ†â‹+`1+Â¯1â†“g((Â¯1âˆ¾âŠ£)(âŠ£â‹âŠ¸âŠâŠËœ-âŠËœâŸœâ‹)âŸœâ‹1(+`âˆ˜âˆ¾-âˆ¾Ëœ)âŠ)oâˆ¨slâˆ¨ğ•©âˆŠbS
  revâŠËœâ†©â‹{+`âŒ¾((â‹+`ğ•©)âŠ¸âŠ)ğ•©>0}revâŠbr
  bvâ†revâŠbrâ‹„bâ†/beâ†bv<0
  Hâ†<Ëâˆ˜â‰2â†•(1âˆ¾Ëœbv>0)/Â·+`0âˆ¾Ëœ(revâŠğ•©)âˆŠ(5âŠ‘bI)+âŠ¢
  ftâ†0âˆ¾(Hâ†•3)+2Ã—(Hâ¥Š3)âŒˆ2Ã—Hâ¥Š4
  râ†©((1â†“ft)âŠ(1+2âŠ¸â‰¤)âŠ¸/â†•4)âŒ¾((be/rev)âŠ¸âŠ)r

  gâ†©â‹+`revâŠp-brâ‹„grâ†gâŠrevâ‹„sllâ†1+2Ã·Ëœ0(<-â—‹/>)grâŠsr-slâ‹„lâ†/grâŠğ•©=5âŠ‘bB
  gâŠËœâ†©gsâ†â‹grâŠslâ‹„grâ†©gâŠrevâ‹„ğ•©âŠËœâ†©grâ‹„râŠËœâ†©grâ‹„oâŠËœâ†©grâ‹„siâ†/grâŠsr>slâ‹„bâŠâ†©â‹gâ‹„lâŠâ†©â‹gs
  sâ†ğ•©âˆŠbSâ‹„psâ†sâˆ¨oâˆ¨grâŠslâ‹„aâ†ğ•©âˆŠ2â†‘bG
  r-â†©psâˆ¨aâ‹„opâ†râ‰¥2â‹„roâ†opâˆ¨1âŒ½r=3
  trâ†(âŒˆ`â†•âˆ˜â‰ âŠ¸Ã—Â¯1âŒ½ps)âŠroâˆ¨râ‰¥1
  tfâ†(aâ‰¤â—‹(âŒˆ`(1+â†•âˆ˜â‰ )âŠ¸Ã—)ps)âˆ§(âŠ¢âˆ§2(|<â‰¤)ps(âŠ¢-âŒˆ`âˆ˜Ã—)+`)Â¬ro
  opaâ†op>1â†“0âˆ¾Ëœpsâˆ¨aâ‹„osâ†âŒ½â†•âˆ˜â‰ âŠ¸(âŠ£-âŒˆ`âˆ˜Ã—)âŒ½Â¬ro
  oaâ†âŒ½/opaâ‹„faâ†/(tfâˆ¨Â¬tr)âˆ§(roâˆ§1âŒ½opa)<(r=1)âˆ¨op<Â¯1âŒ½opa
  dyâ†faâŠ1â†“0âˆ¾Ëœ(ğ•©â‰ âŠ‘bO)âˆ§(trâˆ§râ‰¥0)âˆ¨ro<r=0
  nâ†ğ•©â‰¥vi+nvâ‹„idâ†/(n<ğ•©â‰¥vi)â‹„spâ†/ğ•©âˆŠbIâ‹„cnâ†/nâˆ¨ğ•©â‰¤Â¯1âŠ‘bCâ‹„uâ†â·obâ†cnâŠğ•©
  loâ†(o/ğ•©)=4âŠ‘bBâ‹„llâ†1+lo/1(â†“--âŠ¸â†“)(oâˆ¾1)/+`(sâˆ¾0)-(1âˆ¾o)âˆ§psâˆ¾1
  drâ†/s>o+`âŠ¸âŠ0âˆ¾loâ‹„rtâ†/ğ•©=2âŠ‘bB
  cfâ†gâŠ+`bv>0
  dlâ†+`â‰ Â¨deâ†Â¯1â†“(âŠâŸœcfâŠ”â—‹(âˆ¾âŸœ(1++Â´bv>0))âŠâŸœğ•©)1+/ğ•©=âŠ‘bG
  fdâ†0âˆ¾(bv>0)/revâŠ+`br
  idfâ†dlâ‹idlâ†deâˆ¾âŠ¸âŠidâŠğ•©
  iddâ†(idâŠcf)-â—‹(âŠâŸœfd)idf
  idiâ†idl-idfâŠ0âˆ¾dl
  isâ†idâˆ¾sp
  orâ†â‹gâŠËœâˆ¾âŸ¨cn,cn,is,is,is,b,b,rt,1+/a,dr,l,l,si,si,oa+1âŒˆoaâŠos,(dyÃ—âŠâŸœos)âŠ¸+fa+dyâŸ©
  bc1â†âŸ¨0Â¨cn,uâŠob,21+(is-1)âŠa,iddâˆ¾0Â¨sp,(idiâˆ¾+âŸœ(0âŠ¸â‰¤)2+vi-ËœspâŠğ•©)+3Ã—2|(idfâˆ¾spâŠcf)âŠft,15Â¨b,1+â†•â‰ bâŸ©
  bcâ†orâŠâˆ¾bc1âˆ¾âŸ¨25Â¨rt,12Â¨/a,14Â¨dr,3Â¨l,ll,3Â¨si,sll,5+oaâŠr,5+dy+4Ã—faâŠtrâŸ©
  âŸ¨LEBv bc,u,(ftâŠâ¥Š"fmd"â‰âŒœâŒ½â†•2)âˆ¾Â¨(((â¥ŠÂ¨â€¢aâ†‘Ëœâ‰ )Â¨de)âˆ¾ËœÂ¨ftâŠspd)<âˆ˜â‰Ë˜Ëœ/1âˆ¾orâˆŠ(+Â´â‰ Â¨bc1)+â†•â‰ rtâŸ©
}

primsâ†âŸ¨
  +,-,Ã—,Ã·,â‹†,âˆš,âŒŠ,âŒˆ,|,Â¬,âˆ§,âˆ¨,<,>,â‰ ,=,â‰¤,â‰¥,â‰¡,â‰¢,âŠ£,âŠ¢,â¥Š,âˆ¾,â‰,â†‘,â†“,â†•,âŒ½,â‰,/,â‹,â’,âŠ,âŠ‘,âŠ,âŠ’,âˆŠ,â·,âŠ”,!
  Ëœ,Ë˜,Â¨,âŒœ,â¼,Â´,Ë,`
  âˆ˜,â—‹,âŠ¸,âŸœ,âŒ¾,âŠ˜,â—¶,â‰,âš‡,âŸ
âŸ©
DGenFnâ†{
  âŸ¨t,r,nVar,litsâŸ©â†Tokenizeğ•©
  âŸ¨bc,u,blkâŸ©â†nVarâ€¿r DParse t
  oâ†(u-(vi+nVar-â‰ prims)Ã—uâ‰¥vi)âŠprimsâˆ¾LitValÂ¨lits
  âŸ¨bc,o,âŸ¨âŸ©,blkâŸ©
}
DRunâ†{
  â€¢COMP DGenFn ğ•©
}
