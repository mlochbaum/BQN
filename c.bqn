#!/usr/bin/env bqn

âŠ”â†©((â†•1+(>âŒˆÂ´))=Â¨<)âˆ˜âŠ£ /Â¨âŸœ< â†•âˆ˜â‰ â âŠ¢

lfâ€¿tabâ†â€¢UCS 10â€¿9
chRâ†"â"                   â Remark
chDâ†â€¢d â +âŸœ(â†•10)âŒ¾â€¢UCS'0'  â Digit
chNâ†"Â¯.Ï€âˆ"                â Numeric
chAâ†' '(âŠ¢âˆ¾+)âŒ¾â€¢UCSâ€¢a       â Alphabetic
chUâ†"_"                   â Underscore
chFâ†"+-Ã—Ã·â‹†âˆšâŒŠâŒˆ|Â¬âˆ§âˆ¨<>â‰ =â‰¤â‰¥â‰¡â‰¢âŠ£âŠ¢â¥Šâˆ¾â‰â†‘â†“â†•âŒ½â‰/â‹â’âŠâŠ‘âŠâŠ’âˆŠâ·âŠ”" â Function
chMâ†"ËœË˜Â¨âŒœâ¼Â´`"             â Modifier
chCâ†"âˆ˜â—‹âŠ¸âŸœâŒ¾â‰âš‡âŸ"            â Composition
chPâ†"ğ•¨ğ•ğ•©ğ•ğ•—ğ”½ğ•˜ğ”¾"            â Parameter
chWâ†" "âˆ¾tab               â Whitespace
chSâ†"â‹„,"âˆ¾lf               â Separator
chGâ†"â†â†©â†’"                 â Gets
chBâ†"(){}âŸ¨âŸ©"              â Bracket
chLâ†"â€¿"                   â Ligature
chQâ†"'"""                 â Quote

Hexâ†16âŠ¥(â€¢dâˆ¾"ABCDEF")âŠ¸âŠ
MakeTabâ†{(â‰ chF)â†‘âŠ‘Â¨(chFâŠğ•¨)âŠ”ğ•©}
tab1â†"|-âŒˆâŒŠâˆšÃ·"  MakeTab (<(Hex"10")âˆ¾1)âˆ¾Ëœâ¥ŠÂ¨(Hex"99")+((â†•4)âˆ¾6)
tab2â†"âŠ£+-Ã—Ã·âŒŠâŒˆ" MakeTab â¥ŠÂ¨(Hex"1A")âˆ¾(Hex"A0")+â†•6

Parseâ†{
  âŸ¨âŸ©Parseğ•©;argsâ†ğ•¨â‹„xâ†ğ•©
  x(/Ëœ)â†©Â¬(xâˆŠchW)âˆ¨<â—‹(âŒˆ`â†•âˆ˜â‰ âŠ¸Ã—)Â´(lfâˆ¾chR)=âŒœx
  x(/Ëœ)â†©Â¬(1âŒ¾âŠ‘1âŒ½1âŒ¾âŠ‘)âŠ¸âˆ§xâˆŠchS
  aâ†xâˆŠ"â†â†©"â‹„atâ†1âŒ½aâ‹„varsâ†at/xâ‹„x(/Ëœ)â†©Â¬aâ‹„a(/Ëœ)â†©Â¬at
  lâ†â‰ xâ‹„sepâ†xâˆŠchSâ‹„xâ†©'âŠ£'Â¨âŒ¾(sepâŠ¸/)x
  oâ†x='('â‹„câ†x=')'â‹„vâ†a-ËœxâˆŠâ€¢dâˆ¾argsâˆ¾varsâ‹„fâ†Â¬oâˆ¨câˆ¨vâˆ¨sep
  naâ†(2Ã—sep)+fÃ—1+lâ†‘0âˆ¾câˆ¨v
  eâ†/câ‹„dâ†+`o-c
  edâ†eâŠdâ‹„bâ†(â‹â‹ed)âŠ(â‹âŠâŸœd)âŠ¸âŠ/o
  gâ†âŠ”edâˆ¾0â‹„sâ†e-(eâŠËœâˆ¾(â‹âŠâŠ£)Â¨Â´â‰2â†•g)âŒ¾((âˆ¾1â†“g)âŠ¸âŠ)lÂ¨e
  feâ†fÃ—(l-1)++`(-âŠ¸â‰s)âŒ¾((eâ‰b)âŠ¸âŠ)lâ¥Š0
  feâŒŠâ†©(l-1)-lâ†‘(âŒˆ`â†•âˆ˜â‰ âŠ¸Ã—)âŒ¾âŒ½1âˆ¾Ëœsep
  iaâ†+`lâ†‘0âˆ¾f-lâ†‘/â¼âˆ§f/fe
  selâ†Â¬âˆ˜âŠâŸœ(oâˆ¨c)âŠ¸/â‹(feâŒˆâ†•l)-ia
  âŸ¨selâŠ¸âŠÂ¨xâ€¿na,argsâˆ¾vars,varsâŸ©
}

f64â†127-3
GenFnâ†{
  âŸ¨xâ€¿na,vars,locsâŸ©â†ğ•©
  fnsâ†{
    nâ†â€¢dâŠ<ğ•©
    n=â‰ â€¢d:(Hex"20")âˆ¾varsâŠ<ğ•©
    n=0:8â¥Š0
    lâ†2(âŒŠâ‹†â¼)n
    (Hex"44")âˆ¾2âŠ¥Ë˜âŒ½8â€¿8(âŠ£â¥ŠÃ—Â´âŠ¸â†‘)âˆ¾âŸ¨â¥Š0,(11â¥Š2)âŠ¤1023+l,(2â¥ŠËœ0âŒˆl)âŠ¤nâŸ©
  }â€¿{
    vâ†varsâŠ<ğ•©â‹„v<â‰ vars:(Hex"22")âˆ¾v
    tab1âŠ‘ËœchFâŠ<ğ•©
  }â€¿{
    tab2âŠ‘ËœchFâŠ<ğ•©
  }
  ((â‰ âˆ¾âˆ¾)âŸ¨locsâ‰ âŠ¸âˆ¾f64âŸ©)âˆ¾(Hex"0B")âˆ¾Ëœâˆ¾naâŠ‘âŸœfnsâŠ¸{ğ•ğ•©}Â¨x
}

Genâ†{
  LEBâ†{0â‰¡ğ•©:â¥Š0â‹„128âŠ¸+âŒ¾(Â¯1âŠ¸â†“) 2âŠ¥âŒ½â‰ (âˆ¨`âŒ¾âŒ½âˆ¨Â´Ë˜)âŠ¸/ 10â€¿7(âŠ£â¥ŠÃ—Â´âŠ¸â†‘) â‰âŒ½(8â¥Š2)âŠ¤ğ•©}
  Câ†LEBâˆ˜â‰ âŠ¸âˆ¾
  Sâ†âˆ¾âŸœC
  Vâ†â‰ âˆ¾âˆ¾
  Iâ†Câˆ˜â€¢UCS
  tâ€¿nâ€¿bâ†ğ•©
  âˆ¾âŸ¨
   0âˆ¾(â€¢UCS"asm")âˆ¾4â†‘1
   1 S V (96âˆ¾âŸœâˆ¾CÂ¨)Â¨t
   3 S V â¥ŠÂ¨â†•â‰ b
   7 S V IâŠ¸(âŠ£âˆ¾0âˆ¾âŠ¢)Â¨âŸœ(â†•âˆ˜â‰ )n
  10 S V CÂ¨ b
  âŸ©
}

Compileâ†{
  bodyâ†GenFnâˆ˜Parse ğ•©
  rcpâ†"x" GenFnâˆ˜Parse "1Ã·x"
  Gen âŸ¨âŸ¨0â€¿1,1â€¿1âŸ©/Â¨Â¨f64 â‹„ â¥Š<"fn" â‹„ âŸ¨body,rcpâŸ©âŸ©
}
