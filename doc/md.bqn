# The Markdown function is a markdown to html converter for a "good
# enough" subset of Github-flavored markdown, as specified at
# https://github.github.com/gfm/ .
#
# Additionally, it highlights code sections as BQN, and executes
# sections that are doubly indented (eight spaces), placing their
# results below them.

# Not supported:
# - Thematic breaks like *** or ---
# - Setext headings (underlined with ==== or ----)
# - Fenced code blocks (marked off with ``` or ~~~)
# - HTML blocks
# - Link reference definitions (who uses these?)
# - Block quotes (start with >)
# - Task lists

# Here, a markdown file is represented as a list of its lines, which are
# strings (they don't include any line ending character).
# The html file is constructed directly as a string, using Html.

JoinLines â† âˆ¾ âˆ¾âŸœlfÂ¨

# Create an html node
Html â† {
  tag â† "<"â€¿"</" âˆ¾Â¨ <ğ•¨âˆ¾">"
  âˆ¾ âŸ¨âŠ‘tag , ğ•© , Â¯1âŠ‘tagâŸ©
}

Markdown â† {
  # âŒœ
  # Utilities

  # Index of first zero, or number of leading 1s
  Lead â† âŠ‘ âŠâŸœ0

  # Shift cells ğ•¨ into array ğ•©, maintaining its total length
  Shl â†   â‰ âˆ˜âŠ¢ â†‘ âˆ¾   # From the left
  Shr â† -âˆ˜â‰ âˆ˜âŠ¢ â†‘ âˆ¾Ëœ  # From the right

  # Find whether ğ•¨ was true at the last index where ğ•© was false, in each
  # position.
  PrecedesGroup â† {
    (0 âˆ¾ ğ•¨) âŠËœ âŒˆ` (1 + â†•â‰ ğ•©) Ã— Â¬ğ•©
  }

  # âŒœ
  # First we classify each line based on the type of block it can start.
  ClassifyLine â† (0<â‰ )â—¶(0â€¿0)â€¿{
    FindGroup â† { âŠ‘ (+`â‰ Â¨ğ•¨) â‹ ğ•¨ âˆ¾âŠ¸âŠ ğ•© }
    ind â† lineChars FindGroup âŠ‘ğ•©
    getLen â† ind âŠ‘ lineClasâˆ¾âŸ¨0ËœâŸ©
    l â† GetLen ğ•©
    âŸ¨ind âˆ§ l>0 â‹„ lâŸ©
  }

  # Non-empty lines in code blocks have 4 leading spaces
  IsCode â† 4 (â‰¤âŸœâ‰ )â—¶âŸ¨0,âˆ§Â´' '=â†‘âŸ© âŠ¢
  ProcCode â† {
    lines â† JoinLines 4 â†“Â¨ ğ•©
    #lines â†© âˆ¾â¥ŠÂ¨ ("<>"âŠ¸âŠ âŠ‘âŸœâŸ¨"&lt;","&gt;"âŸ©âŸ(2>âŠ£)Â¨ âŠ¢) lines
    "pre" Html doHighlightâ—¶âŸ¨"code"âŠ¸Html,HighlightâŸ© lines
  }

  # Headings start with #, and require 1-6 #s followed by a space.
  # Any trailing #s are ignored.
  LenHeading â† {
    n â† Lead ğ•©='#'
    l â† (0<n) âˆ§ (6â‰¥n)
    s â† n (<âŸœâ‰ )â—¶âŸ¨1,' '=âŠ‘âŸ© ğ•© # Character after hashes must be a space, if any
    n Ã— l âˆ§ s
  }
  ProcHeading â† {
    tag â† "h" âˆ¾ ğ•¨âŠâ€¢d        # h3 for 3 hashes, etc.
    ğ•© â†“Ëœâ†© ğ•¨+1
    trsp â† âˆ§`âŒ¾âŒ½ ğ•©=' '
    tail â† âˆ§`âŒ¾âŒ½ trspâˆ¨ğ•©='#'  # Mask of trailing hashes
    f â† tail < 0 Shr tail   # Character before trailing hashes
    ğ•© /Ëœâ†© Â¬ f (âŠ‘âŸ¨"\"," ",""âŸ©âŠ<f/ğ•©)â—¶âŸ¨âŠ£,âŠ¢,âŠ¢,0Â¨âŠ¢âŸ© tail
    ğ•© /Ëœâ†© Â¬ (âˆ§` âˆ¨ âˆ§`âŒ¾âŒ½) ' '=ğ•©
    tag Html ProcInline ğ•©
  }âŸœâŠ‘

  # List items start with a bullet (unordered) or number (ordered).
  LenBullet â† 2 Ã— 1 (<âŸœâ‰ )â—¶âŸ¨0,' '=âŠ‘âŸ© âŠ¢
  LenListNum â† {
    n â† Lead ğ•©âˆŠâ€¢d
    l â† (1â‰¤n) âˆ§ (9â‰¥n)
    ' ' = n â†“ ğ•©
    t â† nâ†“(n+2)â†‘ğ•©
    l âˆ§ (" " â‰¡ 1â†“t) âˆ§ âŠ‘(")." âˆŠËœ 1â†‘t)
  }

  # Tables are not yet supported
  IsTable â† 0Ëœ

  # Paragraphs
  ProcParagraph â† {
    Trsp â† { mâ†âˆ§`âŒ¾âŒ½ğ•©=' ' â‹„ (mÂ¬âŠ¸/ğ•©)âˆ¾(ğ•¨<âˆ¨Â´m)/"<br />" }
    ğ•© â†© (/(â‰ ğ•©)(-âˆ¾âŠ¢)1) TrspÂ¨ ğ•©
    "p" Html ProcInline Â¯1 â†“ JoinLines ((Lead ' 'âŠ¸=)+"\#"â‰¡2âŠ¸â†‘)âŠ¸â†“Â¨ ğ•©
  }

  # Inline elements
  ProcInline â† {
    sâ†"`*"=âŒœğ•©
    dâ†<âˆ˜/Ë˜s
    câ†âŠsâ‹„râ†Â¯1âŒ½lâ†â‰ `câ‹„csâ†lâˆ§c
    codeâ†HighlightâŸdoHighlightÂ¨(1-Ëœ(lâˆ§r)Ã—+`cs)âŠ”ğ•©
    incâ†Â¬lâˆ¨âˆ¨Â´<Ë˜s
    tagsâ†âˆ¾dâ‰ âŠ¸â¥ŠÂ¨âŸ¨"<code>"â€¿"</code>","<em>"â€¿"</em>"âŸ©
    ((/inc)âˆ¾(â‰ Â¨tagsâˆ¾code)/(âˆ¾d)âˆ¾/cs) â‹âŠ¸âŠ (inc/ğ•©)âˆ¾âˆ¾tagsâˆ¾code
  }âŸdoHighlight

  lineCharsâ€¿lineClasâ€¿procFns â† <Ë˜â‰>âŸ¨
    ""    â€¿ (!âˆ˜0)       â€¿ ProcParagraph
    "#"   â€¿ LenHeading  â€¿ ProcHeading
    " "   â€¿ IsCode      â€¿ ProcCode
    "-+*" â€¿ LenBullet   â€¿ (âˆ¾âŠ¢) # ProcBullet
    â€¢d    â€¿ LenListNum  â€¿ (âˆ¾âŠ¢) # ProcListNum
    "|"   â€¿ IsTable     â€¿ (âˆ¾âŠ¢) # ProcTable
  âŸ©

  # âŒœ
  # We will also use the length and number of leading blanks.
  lengths â† â‰ Â¨ ğ•©
  blanks â† (Lead ' 'âŠ¸=)Â¨ ğ•©
  nonEmptyMask â† blanks < lengths
  # Now let's use the line classifications to get the block structure.
  lineTypeâ€¿lineDat â† <Ë˜â‰ > ClassifyLineÂ¨ blanks â†“Â¨ ğ•©

  # We will construct a mask of lines that start new blocks, blockStart.

  codeMask â† nonEmptyMask âˆ§ blanks â‰¥ 4
  lineType -â†© codeMask âˆ§ 1 = lineType
  paragraphMask â† nonEmptyMask âˆ§ 0 = lineType

  # Code blocks consist of indented lines, possibly with blank lines
  # in between. They must be separated from paragraphs by blank lines.
  codeMask âˆ§â†© Â¬ paragraphMask PrecedesGroup codeMask
  codeMask âˆ¨â†© codeMask (âŠ¢ âˆ§ PrecedesGroup âˆ§ PrecedesGroupâŒ¾âŒ½) Â¬ nonEmptyMask
  lineType â†© 2Â¨âŒ¾(codeMaskâŠ¸/) lineType
  paragraphMask âˆ§â†© Â¬ codeMask

  # Lists group together for now
  bulletListMaskâ€¿orderedListMask â† <Ë˜ 3â€¿4 =âŒœ lineType

  drop â† blanks Ã— lineType < 2

  # Lines continue blocks if they are part of the same multi-line
  # type as the previous line, and otherwise start new ones.
  blockMasks â† codeMaskâ€¿bulletListMaskâ€¿orderedListMaskâ€¿paragraphMask
  blockStart â† nonEmptyMask âˆ§ Â¬ âˆ¨Â´ (âŠ¢ âˆ§ 0âŠ¸Shl)Â¨ blockMasks

  ProcBlock â† {tâ€¿l G b: fâ†tâŠ‘procFns â‹„ l F âŠ‘b }
  blocks â† (1 -Ëœ (nonEmptyMask âˆ¨ codeMask) Ã— +`blockStart) âŠ” drop â†“Â¨ ğ•©
  JoinLines (blockStart / lineTypeâ‰Ë˜lineDat) <âˆ˜ProcBlockË˜ blocks
}

# âŒœ
# Testing
# Uses the test cases at https://spec.commonmark.org/0.29/spec.json
# since Github doesn't seem to have published theirs
TestSections â† {
  doHighlight â†© 0
  tests â† Â¯2 â†“Ë˜ 8âŠ¸(Ã·ËœâŸœâ‰ âˆ¾âŠ£)âŠ¸â¥Š2â†“â€¢LNS â€¢pathâˆ¾"../spec.json"
  tests â†© ((âŠ‘2+âŠâŸœ':')Â¨âˆ˜âŠ ((-','=Â¯1âŠ‘âŠ¢)â†“â†“)Â¨â‰1 âŠ¢) tests
  testSection â† (1â†“Â¯1â†“âŠ¢)Â¨ 5âŠË˜tests
  UnEsc â† {
    esc â† (2 | (1+â†•âˆ˜â‰ ) (âŠ£-âŒˆ`âˆ˜Ã—) '\'â‰ âŠ¢) ğ•©
    esc Â¬âŠ¸/ (("\"""âˆ¾â€¢UCS 9â€¿10)âŠËœ"\""tn"âŠâŠ¢)âŒ¾((Â¯1âŒ½esc)âŠ¸/) ğ•©
  }
  RunTest â† {
    inâ€¿exp â† UnEscâˆ˜(1â†“Â¯1â†“âŠ¢)Â¨2â†‘ğ•©
    out â† Markdown (â€¢UCS 10) ((âŠ¢-ËœÂ¬Ã—+`)âˆ˜=âŠ”âŠ¢) in
    âŸ¨expâ‰¡out,in,exp,out,2âŠ‘ğ•©âŸ©
  }

  ignore â† (2 âŠË˜ tests) âˆŠ âŸ¨"47","85"âŸ©
  res â† 1 â†“Ë˜ (Â¬âŠË˜)âŠ¸/ RunTestË˜ tests /Ëœ ignore < testSection âˆŠ ğ•©
  doHighlight â†© 1
  res
}

# âŒœ
# Syntax highlighting
doHighlight â† 1
Highlight â† {
  idChars â† âŸ¨
    â€¢dâˆ¾"Â¯.Ï€âˆ"
    ' '+âŒ¾â€¢UCSâ€¢a
    â€¢a
    "_"
  âŸ©
  classesâ€¿chars â† <Ë˜ â‰ 2âŠ¸(Ã·ËœâŸœâ‰ âˆ¾âŠ£)âŠ¸â¥ŠâŸ¨
    0             , " "âˆ¾â€¢UCS 9â€¿10
    "Value"       , Â¯1âŠË˜5â€¿2â¥Š"ğ•¨ğ•©ğ•—ğ•˜ğ•¤"
    "Function"    , "+-Ã—Ã·â‹†âˆšâŒŠâŒˆ|Â¬âˆ§âˆ¨<>â‰ =â‰¤â‰¥â‰¡â‰¢âŠ£âŠ¢â¥Šâˆ¾â‰â†‘â†“â†•âŒ½â‰/â‹â’âŠâŠ‘âŠâŠ’âˆŠâ·âŠ”!"âˆ¾Â¯1âŠË˜5â€¿2â¥Š"ğ•ğ•ğ”½ğ”¾ğ•Š"
    "Modifier"    , "ËœË˜Â¨âŒœâ¼Â´`"
    "Composition" , "âˆ˜â—‹âŠ¸âŸœâŒ¾âŠ˜â—¶â‰âš‡âŸ"
    "Number"      , âˆ¾idChars
    "Gets"        , "â†â†©â†’"
    "Paren"       , "()"
    "Bracket"     , "âŸ¨âŸ©"
    "Brace"       , "{}"
    "Ligature"    , "â€¿"
    "Nothing"     , "Â·"
    "Separator"   , "â‹„,"
    "Comment"     , "#"
    "String"      , "'"""
  âŸ©
  classTag â† ""â€¿""âˆ¾>{âŸ¨"<span class='"âˆ¾ğ•©âˆ¾"'>","</span>"âŸ©}Â¨1â†“classes
  FindGroup â† { (+`â‰ Â¨ğ•¨) â‹ (âˆ¾ğ•¨) âŠ ğ•© }

  râ†ğ•©='#'â‹„sâ†/(â‰ â†‘2âŠ¸â†“)âŠ¸âˆ§ğ•©='''â‹„dâ†/ğ•©='"'
  gâ†â‹qâ†âˆ¾âŸ¨  sâ‹„Â¯1â†“dâ‹„/râŸ© â‹„qâ†©gâŠq
  eâ† gâŠâˆ¾âŸ¨2+sâ‹„ 1â†“dâ‹„(âŠ¢-Â¯1â†“0âˆ¾âŠ¢)âˆ˜âŠâŸœ(0âˆ¾+`r)âŠ¸//(ğ•©=lf)âˆ¾1âŸ©
  Seâ†{(âŠËœğ•¨)Se 1Â¨âŒ¾((ğ•©/ğ•¨)âŠ¸âŠ)ğ•©}âŸ{0=âŠ‘âŒ½ğ•©}
  stâ†Â¯1â†“SeâŸœ(1â†‘Ëœâ‰ )âˆ¾âŸœâ‰ qâ‹eâ‹„bâ†st/qâˆ¾Ë˜e
  ToIâ†Â¯1â†“Â·/â¼(â‰ ğ•©)âˆ¾Ëœâ¥Š
  scâ†+Â´(1â€¿2-Ëœâ‰ classes)Ã—(â‰ `âˆ¨âŠ¢)âˆ˜ToIâˆ˜>Â¨Â¯1â†“((st/q)âŠr)âŠ”â—‹(âˆ¾âŸœ2)<Ë˜b
  colâ†scâŒˆ14|chars FindGroup ğ•©

  wâ†(â‰ â†‘0âˆ¾âŠ¢)âŠ¸<idâ†col=5
  idcâ†1+5|1-Ëœ(idChars FindGroup w/ğ•©)+'_'=((1â†“âˆ¾âŸœ0)âŠ¸<id)/ğ•©
  colâ†©((id/+`w)âŠ0âˆ¾idc)âŒ¾(idâŠ¸/)col

  colâ†©(1âŒ½col)âŠ£âŒ¾((ğ•©=âŠ‘"ğ•©")âŠ¸/)col

  bdâ†(â‰ â†‘Â¯1âˆ¾âŠ¢)âŠ¸â‰ col
  fâ†0<bd/col
  tagsâ†â¥Šf/(bd/col)âŠclassTag
  posâ†â¥Šf/2â†•/bdâˆ¾1
  ((â†•â‰ ğ•©)âˆ¾Ëœ(â‰ Â¨tags)/pos) â‹âŠ¸âŠ ğ•©âˆ¾Ëœâˆ¾tags
}

head â† "<head><link href=""style.css"" rel=""stylesheet""/></head>"âˆ¾lf
ConvertFile â† head âˆ¾ Markdownâˆ˜â€¢LNS
