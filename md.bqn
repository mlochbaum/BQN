# The Markdown function is a markdown to html converter for a "good
# enough" subset of Github-flavored markdown, as specified at
# https://github.github.com/gfm/ .

# Extensions are used whenever a source filename is given (mainly just
# so testing won't use them). They:
# - Add id= slugs to headers that match Githubs, for linking
# - Adjust relative links to account for filename changes
# - Highlight inline and block code as BQN
# - Place code blocks in <pre> tags only, not <pre><code>
# - Insert results into doubly-indented (8 spaces) code blocks
# - Add links to open and execute code in the REPL

# Supports:
# - ATX headings (start with hashes #)
# - Paragraphs
# - Indented code blocks
# - Inline and raw HTML in a way that doesn't match the spec at all
# - Tables
# - Lists, unordered with single-line items only; can be nested
# - Inlines: code fully, links partially, and emphasis somewhat

# Important missing features:
# - Thematic breaks like *** or ---
# - Setext headings (underlined with ==== or ----)
# - Fenced code blocks (marked off with ``` or ~~~)
# - Block quotes (start with >)
# - Strikethrough (~~text~~)
# - Images (like links)
# - Hard line breaks (trailing spaces or backslash)

# Here, a markdown file is represented as a list of its lines, which are
# strings (they don't include any line ending character).
# The html file is constructed directly as a string, using Html.

################################
# Utilities

# Linefeed
lf â† @+10

# Index of first zero, or number of leading 1s in a boolean list
Lead â† âŠ‘ âŠâŸœ0

# ğ•¨ is a list of lists. Find the first of these lists each cell of ğ•©
# belongs to.
FindGroup â† {
  i â† (âˆ¾ğ•¨) âŠ ğ•©  # Index in all cells of ğ•¨
  e â† +`â‰ Â¨ğ•¨     # Index past the end of each group of ğ•¨
  e â‹ i         # How many end-indices does each element pass?
}

# Count the number of consecutive true values up to the current element.
# To do this, subtract the index of the last false character from the
# current index.
CountRuns â† { (1+â†•â‰ ğ•©) (âŠ£ - âŒˆ`âˆ˜Ã—) Â¬ğ•© }

# ğ•© is a string; return a mask of the characters that are escaped, that
# is, preceded by an odd number of backslashes (since a backslash can
# escape another backslash).
# Another implementation is {Â»<`ğ•©='\'}.
IsEscaped â† {
  Â» 2 | CountRuns ğ•© = '\'
}

# Remove leading (âˆ§`) and trailing (âˆ§`âŒ¾âŒ½) spaces
Trim â† { ğ•© /Ëœ Â¬ (âˆ§` âˆ¨ âˆ§`âŒ¾âŒ½) ' '=ğ•© }

# Find whether ğ•¨ was true at the last index where ğ•© was false, in each
# position.
PrecedesGroup â† {
  # We prepend a 0 to ğ•¨, so that 0 is the "before start" index, with a
  # false value, and normal indices are increased by 1.
  ğ•¨ âˆ¾Ëœâ†© 0
  inds â† 1 + â†•â‰ ğ•©
  # Zero out indices where ğ•© was true, and find the greatest index so
  # far at each position.
  last â† âŒˆ` inds Ã— Â¬ğ•©
  last âŠ ğ•¨
}

# ğ•¨ is a list of possible expression start indices in any order and ğ•© is
# the corresponding endpoints. The expressions are mutually exclusive
# and do not nest, and are enabled in index order. Return a shape Â·â€¿2
# array where the rows give the start and end of each enabled expression
# in index order.
Trace â† {
  # ğ•¨ is a list with one index for each possible start, giving a later
  # start that is known to be enabled if that one is.
  # ğ•© is a list of all starts known to be enabled.
  # A "stop" position that follows all expressions tells when to stop.
  # At each step the distance from a start to its successor in ğ•¨ is
  # doubled, so the maximum number of steps is about 2â‹†â¼â‰ ğ•©.
  En â† {
    ğ•© âˆ¾â†© ğ•©âŠğ•¨           # Add starts following from an enabled one
    ğ•¨ â†© âŠËœ ğ•¨           # Double the number of steps in ğ•¨
    ğ•¨ En ğ•©             # Repeat
  }âŸ{stopâ‰ Â¯1âŠ‘ğ•©}        #        until the stop is reached

  g â† â‹ğ•¨               # Order expressions by starting index
  start â† gâŠğ•¨
  end   â† gâŠğ•©
  next â† start â‹ end   # An expression's successor starts after it ends
  next âˆ¾â†© stopâ†â‰ next   # The stop node is its own successor
  enabled â† stopâŠ¸>âŠ¸/ next En â‹ˆ0  # Search, then remove stops
  enabled âŠ startâ‰Ë˜end # List of enabled starts and ends
}

# Join lines with newline characters. Include a trailing newline.
JoinLines â† âˆ¾ âˆ¾âŸœlfÂ¨

# Given a list of begin-end pairs run together, return a list
Ranges â† {
  R â† {ğ•¨+â†•ğ•©Â¬ğ•¨}  # Single range
  ğ•© â†© âˆ˜â€¿2 â¥Š ğ•©   # Reshape into pairs
  âˆ¾ RÂ¨ËË˜ ğ•©
}
# âˆŠâŸœRanges assuming ğ•¨ is sorted
InRanges â† {
  ğ•© +â†© 2|â†•â‰ ğ•©  # Since â‹ works with half-open intervals
  2 | ğ•© â‹ ğ•¨
}

# Create an html node from a tag name and interior text.
Html â† {open ğ•Š contents:
  close â† (âŠ‘openâŠ" ") â†‘ open
  âˆ¾ âŸ¨"<",open,">" , contents , "</",close,">"âŸ©
}

# Insert and remove things from the list ğ•©:
# - include is the mask of elements to keep in ğ•©
# - add is a list of lists to be inserted
# - pos is the list of positions where they should start
# Elements are added just after the given position in ğ•©, in the order
# they appear in âˆ¾add.
Modify â† { âŸ¨include,add,posâŸ©ğ•Šğ•©:
  ((/include)âˆ¾(â‰ Â¨add)/pos) â‹âŠ¸âŠ (include/ğ•©)âˆ¾âˆ¾add
}

# URL encoding for links to the REPL
UTF8 â† âˆ¾ (2â‹†7) (âŠ£+(2â‹†6){ğ•¨ â‰¤â—¶âŸ¨â¥ŠâŠ¢-2Ã—-âŸœğ•— â‹„ ğ•—(|âˆ¾Ëœ(2Ã·ËœâŒŠâŸœğ•¨)ğ•ŠâŒŠâˆ˜Ã·Ëœ)âŠ¢âŸ© ğ•©}Â¨) -âŸœ@
Base64 â† {
  b64 â† Ranges "AZaz09++//"
  bâ†3|â†•lâ†â‰ uâ†UTF8 ğ•©
  Mâ†((0<â†•4)â¥ŠËœâ‰ )âŠ¸Ã— (1+0=b)âŠ¸/
  vâ†(4â‹†1+b) ((âŒŠâˆ˜Ã·Ëœ) Â«âŠ¸+â—‹M (64Ã·âŠ£)Ã—|) u
  (vâŠb64)âˆ¾(3|-l)â¥Š'='
}

# Various URLs
siteURL â† "https://mlochbaum.github.io/BQN/"
tryURL  â† siteURLâˆ¾"try.html#code="
repoURL â† "https://github.com/mlochbaum/BQN"
blobURL â† repoURLâˆ¾"/blob/master/"

# Environments
NewREPL â† â€¢ReBQNâˆ˜{replâ‡"strict"}
_getCodeExec â† {ğ•—â‹„NewREPL@}
_getSvgExec â† {ğ•—
  eâ†NewREPL@
  âŸ¨"","",GetHighlightsâ€¿Modifyâ€¿EâŸ© E "GetHighlightsâ€¿Modifyâ€¿Evalâ†â€¢args"
  E â€¢file.Chars "svg.bqn"
  JoinLinesâŸ(1<â‰¡)âˆ˜E
}


################################
Markdown â† {filenameğ•Šğ•©:
  extensions â† filename â‰¢ 0
  path â† extensionsâ—¶""â€¿(âŠ¢/ËœÂ·âˆ¨`âŒ¾âŒ½'/'âŠ¸=) filename

  CodeExec â† @_getCodeExec
  GenHtml â† @_getSvgExec

  ######
  # First we classify each line based on the type of block it can start.
  ClassifyLine â† (0<â‰ )â—¶(0â€¿0)â€¿{
    ind â† âŠ‘ lineChars FindGroup âŠğ•©
    getLen â† ind âŠ‘ lineClasâˆ¾âŸ¨0âŸ©
    l â† GetLen ğ•©
    âŸ¨ind âˆ§ l>0 â‹„ lâŸ©
  }

  # Character entity escaping
  # In order to use this with other modifications such as highlighting,
  # CharEntities returns a mask of characters to be escaped, and their
  # corresponding escapes.
  CharEntities â† {1Â¨âŠ¸ğ•Šğ•©;  # ğ•¨ gives characters to potentially escape
    # The string gives escapes and their names, separated by spaces.
    # First split it on the first character.
    ce â† (1-ËœÂ¬Ã—+`)âˆ˜=âŸœâŠ‘âŠ¸âŠ” " ""quot &amp <lt >gt"
    # Characters to escape are given first
    chars â† âŠ‘Â¨ce
    # HTML character entities start with & and end with ;
    entities â† ("&"âˆ¾âˆ¾âŸœ";")Â¨ 1â†“Â¨ce

    # Replace a character if ğ•¨ is not set and it's on our list.
    ind â† chars âŠ ğ•©
    useEntity â† ğ•¨ âˆ§ ind < â‰ chars
    âŸ¨Â¬ useEntity , entities âŠËœ useEntity/ind , /useEntityâŸ©
  }

  # Function to build REPL link
  # May include previous statements to define variables
  makeLink â† {
    lines â† names â† deps â† âŸ¨âŸ©
    { nsâ€¿assignedâ€¿line ğ•Š ğ•©:
      M â† â·âˆ˜âˆ§âˆ˜âˆ¾                       # Merge
      n â† â‰  ls â† ğ•© âŠËœ â·line           # Lines with variables
      lc â† (â‰ lines) + â†•n              # Indices they'll have
      lines âˆ¾â†© ls
      JoinLines ğ•© âˆ¾Ëœ lines âŠËœ (-n) â†“ M lc { lğ•Š[n,a]:
        e â† (â‰ names) > i â† names âŠ n  # Look up the names
        d â† l âˆ¾Ëœ M (e/i) âŠ deps       # Dependencies for this line
        deps MâŸœdÂ¨âŒ¾(((aâˆ§e)/i)âŠ¸âŠ)â†©      # Add these to reassigned names
        names âˆ¾â†© new â† (aâˆ§Â¬e) / n     # Add new names
        deps âˆ¾â†© dÂ¨ new                # With this line's dependencies
        d
      }âŸœâ‰Â¨ (âŠline) âŠ” nsâ‰Ë˜assigned
    }
  }

  # Non-empty lines in code blocks have 4 leading spaces
  ProcCode â† {
    # Strip the leading spaces
    lines â† 4 â†“Â¨ ğ•©
    code â† JoinLines lines

    # Highlight and unescape html-unsafe characters
    câ€¿ci â† extensionsâ—¶(â‹ˆËœâŸ¨âŸ©)â€¿GetHighlights code
    emâ€¿eâ€¿ei â† CharEntities code

    # If every line is indented by at least 4 additional spaces, we will
    # execute each one and insert the results.
    râ€¿riâ€¿link â† {
      extensions ?
      âˆ§Â´ ' ' = âˆ¾ 4 (âŒŠâŸœâ‰  â†‘ âŠ¢)Â¨ lines ?
      # Top-level separators are those not inside brackets
      m â† NotCommentOrString code
      depth â† +` m Ã— "(){}âŸ¨âŸ©[]" (âŠ£(â‰ âŠ¸>Ã—Â·Â¬âŠ¸-2|âŠ¢)âŠ) code
      top â† m âˆ§ 0=depth
      sep â† top âˆ§ codeâˆŠ"â‹„,"âˆ¾lf  # Top-level separators
      break â† sepâˆ§lf=code       # Mask of line breaks
      # Don't show assignment result
      PG â† PrecedesGroup
      a â† mâˆ§codeâˆŠ"â†â†©" â‹„ sid â† mâˆ§codeâˆŠ" "âˆ¾âˆ¾idChars
      sa â† a âˆ§ Â¬(Â¬sep) PG sidâˆ¨a       # Silent assignment
      show â† Â¬ break / sa PG Â¬saâˆ¨Â»sep # If last expression began with one
      # Remove indentation and split lines
      notIndent â† (0âŠ¸=âˆ¨4âŠ¸<) CountRuns Â¬mâˆ§lf=code
      parts â† code âŠ”Ëœ 1 -Ëœ (notIndentâˆ§Â¬break) Ã— 1+`break
      # Evaluate
      E â† âŠ£â—¶âŸ¨"",(â¥Šâˆ¾âŸœlfâ‰1)âˆ˜â€¢FmtâŠ¢âŸ©âŸœCodeExec
      ShowErr â† lfâˆ¾Ëœ"span class='Error'"Html"Error: "âˆ¾(âˆ§`lfâŠ¸â‰ )âŠ¸/âŠâ€¢Repr
      r â† show ('#'â‰ âŠ‘âˆ˜âŠ¢)â—¶âŸ¨"",EâŠ(ShowErrâˆ˜â€¢CurrentErrorâŠ¢)âŸ©âŸ(0<â‰ âˆ˜âŠ¢)Â¨ parts

      # Link that runs the code
      # Parse assignments and variables to add previous lines if needed
      # First locate the names
      In â† 1=+âŸœ(â†•2)âŠ¸â‹
      maâ€¿spâ€¿st â† {mâˆ§code=ğ•©}Â¨"â†© â€¿" â‹„ idâ†sp<sid
      idInd â† / word â† Â»âŠ¸<id          # Starts of words
      lc â† ((-Â´"aA")Ã—"AZ"InâŠ¢)âŠ¸+ code  # Lowercase code
      names â† lc âŠ”Ëœ 1 -Ëœ (idâˆ§'_'â‰ code) Ã— +`word  # Used names
      namesâ€¿idInd ("az"InâŠ‘Â¨names)âŠ¸/Â¨â†© # Filter out numbers
      names (âˆ§`'.'âŠ¸â‰ )âŠ¸/Â¨â†©
      iline â† idInd âŠ +`break         # Line number
      # Find the top-level assignments
      fma â† ma PGâŒ¾âŒ½ Â¬spâˆ¨ma            # Assume anything before â†© with no space is modified assignment
      ea â† top âˆ§ Â»âŠ¸< a âˆ¨ fma          # Character after assignment target
      cont â† sp âˆ¨ (Â»âŠ¸âˆ§ id) âˆ¨ (Â»âŠ¸âˆ¨ st PG sp) âˆ¨ Â» 0<depth
      target â† Â« ea PGâŒ¾âŒ½ cont         # Top-level assignment targets
      ia â† idInd âŠ target             # Whether each name is assigned
      # Build the link element
      lu â† tryURL âˆ¾ Base64 Â¯1 â†“ namesâ€¿iaâ€¿iline MakeLink parts
      l â† "a class=""replLink"" title=""Open in the REPL"" target=""_blank"" href="
      link â† (lâˆ¾""""(âˆ¾âˆ¾âŠ£)lu) Html "â†—ï¸"
      âŸ¨r, /break, linkâŸ©
    ;
      3â¥Š<âŸ¨âŸ©
    }

    mod â† âŸ¨em,eâˆ¾câˆ¾r,eiâˆ¾ciâˆ¾riâŸ© Modify code
    link âˆ¾ "pre" Html "code" HtmlâŸ(Â¬extensions) mod
  }

  # Headings start with #, and require 1-6 #s followed by a space.
  # Any trailing #s are ignored.
  LenHeading â† {
    n â† Lead ğ•©='#'
    l â† (0<n) âˆ§ (6â‰¥n)
    s â† n (<âŸœâ‰ )â—¶âŸ¨1,' '=âŠ‘âŸ© ğ•© # Character after hashes must be a space, if any
    n Ã— l âˆ§ s
  }
  ProcHeading â† {
    tag â† "h" âˆ¾ '0'+ğ•¨       # h3 for 3 hashes, etc.
    ğ•© â†“Ëœâ†© ğ•¨+1
    trsp â† âˆ§`âŒ¾âŒ½ ğ•©=' '
    tail â† âˆ§`âŒ¾âŒ½ trspâˆ¨ğ•©='#'  # Mask of trailing hashes
    f â† <âŸœÂ« tail            # Character before trailing hashes
    ğ•© /Ëœâ†© Â¬ f (âŠ‘âŸ¨"\"," ",""âŸ©âŠ<f/ğ•©)â—¶âŸ¨âŠ£,âŠ¢,âŠ¢,0Â¨âŠ¢âŸ© tail
    ğ•© Trimâ†©
    # Add an id, usually containing only a-z, digits, and hyphens
    Slugify â† {
      ğ•© â†© '-'Â¨âŒ¾((ğ•©=' ')âŠ¸/) ğ•©  # Replace spaces with dashes
      bounds â† â¥Š "Aa"+âŒœ0â€¿26   # Of the upper and lowercase alphabet
      # Lowercase alphabetic characters and remove special characters
      b â† bounds â‹ ğ•©
      ((2|b)âˆ¨âˆŠâŸœ("-ğ•Šğ•ğ•ğ”½ğ”¾ğ•¤ğ•©ğ•¨ğ•£ğ•—ğ•˜Ï€â³"âˆ¾'0'+â†•10))âŠ¸/ ğ•©+32Ã—1=b
    }
    ExtHtml â† ğ•©{
      sâ†Slugify ğ•— â‹„ Q â† """"âŠ¸(âˆ¾âˆ¾âŠ£)
      (ğ•¨ âˆ¾ " id="âˆ¾Q s) Html ("a class=""header"" href="âˆ¾Q"#"âˆ¾s) Html ğ•©
    }
    tag extensionsâ—¶Htmlâ€¿ExtHtml ProcInline ğ•©
  }âŸœâŠ‘

  # List items start with a bullet (unordered) or number (ordered).
  LenBullet â† +âŸœÃ— Â·â‰¤âŸœ4âŠ¸Ã— Â·Lead ' '=1âŠ¸â†“
  ProcBullet â† {
    items â† ğ•¨ â†“Â¨ ğ•©
    indent â† (' '=âŠ‘)Â¨ğ•©
    items â†© { âˆ¨Â´indent ?
      # Require indented lines to form a nested list
      Len â† { ! âˆ§Â´(âŠ‘Â¨ğ•©)âˆŠ"-+*" â‹„ LenBullet âŠ‘ğ•© }
      # Process items recursively
      groups â† 1 -Ëœ (indentâˆ¾1) Ã— +` (Â¬indent)âˆ¾1
      sub â† LenâŠ¸ProcBulletâŸ(0<â‰ )Â¨ groups âŠ” items
      # Append to the first line, which is assumed to stand alone
      (ProcInlineÂ¨ indent Â¬âŠ¸/ items) JoinLinesâˆ˜â‹ˆÂ¨ sub
    ;
      ProcInlineÂ¨ items
    }
    "ul" Html lf âˆ¾ JoinLines "li"âŠ¸HtmlÂ¨ items
  }
  LenListNum â† { # Not used yet
    n â† Lead 1="0:"â‹ğ•©
    l â† (1â‰¤n) âˆ§ (9â‰¥n)
    ' ' = n â†“ ğ•©
    t â† nâ†“(n+2)â†‘ğ•©
    l âˆ§ (" " â‰¡ 1â†“t) âˆ§ âŠ‘(")." âˆŠËœ 1â†‘t)
  }

  # Table detection handled specially because the spec is... special
  CutTableRow â† {
    b â† '|' = ğ•©            # Mask of bars
    o â† (Â¬b) â‰ â—‹Lead ' '=ğ•©  # Leading | omitted
    r â† b > Â» '\' = ğ•©      # Non-escaped bars
    1 -Ëœ (Â¬râˆ¨Â«b>r) Ã— o + +` r
  }
  alignments â† (" align="""âˆ¾âˆ¾âŸœ"""")âŸ(0<â‰ )Â¨ ""â€¿"right"â€¿"left"â€¿"center"
  ProcTable â† {
    rows â† (TrimÂ¨ CutTableRowâŠ¸âŠ”)Â¨ ğ•©
    incl â† Â¬ rule â† (âˆ§Â´âˆ¾âˆŠ"-:"Ë™)Â¨ rows
    align â† alignments âŠËœ (+ËœâŠ¸+Â´0â€¿Â¯1âŠâŠ¢)Â¨ ':' = âŠ‘ rule / rows
    rows â†© (((â‰ align)âŒŠâ‰ )âŠ¸â†‘ ProcInlineÂ¨)Â¨âŒ¾(inclâŠ¸/) rows
    rows â†© (âŠrows) (âŠ¢ âˆ¾ âŸ¨""âŸ© /Ëœ 0âŒˆ-â—‹â‰ )Â¨ rows
    rowType â† incl / +` rule  # Head or body
    tags â† rowType âŠ "th"â€¿"td"
    DoRow â† { lf âˆ¾ JoinLines ğ•¨ HtmlÂ¨ ğ•© }
    rows â†© (<Ë˜ tags âˆ¾âŒœ align) DoRowÂ¨ incl/rows
    rowGroups â† (rowTypeâˆ¾2) âŠ” "tr"âŠ¸HtmlÂ¨ rows
    sections â† "thead"â€¿"tbody" HtmlâŸœ(lf âˆ¾ JoinLines)Â¨ rowGroups
    "table" Html lf âˆ¾ JoinLines (0 < â‰ Â¨rowGroups) / sections
  }

  # Paragraphs
  ProcParagraph â† {
    "p" Html ProcInline Â¯1 â†“ JoinLines TrimâŒ¾(Â¯1âŠ¸âŠ‘) (Lead ' 'âŠ¸=)âŠ¸â†“Â¨ ğ•©
  }

  # HTML blocks
  # Lazy rule: if it starts with < and contains >, it's probably HTML
  IsHtmlBlock â† ("<!--"â‰¡4â†‘âŠ¢)â—¶('>'âˆ¨Â´âˆ˜=âŠ¢)â€¿2
  ProcComment â† {
    nâ†â‰ sâ†"<!--GEN" â‹„ lâ†Â¯3â†“âŸ(1=â‰ ğ•©)âŠ‘ğ•© â‹„ aâ†sâ‰¡nâ†‘l
    Source â† {((0<â‰ )â—¶<â€¿(â€¢file.Lines pathâˆ¾âŠ¢) Trim nâ†“l) âˆ¾ 1â†“Â¯1â†“ğ•©}
    âŸ¨â€¢file.At pathâŸ© GenHtmlâŸa JoinLines SourceâŸa ğ•©
  }
  ProcHtml â† {
    codeMask â† "<code>" (6â¥Š0)âŠ¸Â»âŠ¸(>â—‹(âŒˆ`(1+â†•âˆ˜â‰ )âŠ¸Ã—))â—‹((â‰ ğ•©)â†‘â·âŸœğ•©) "</code>"
    (1Â¨ <âŠ¸âˆ¾ codeMaskâŠ¸GetMultiHighlights)âŠ¸Modify ğ•©
  }âŸœJoinLines
  ProcHtmlBlock â† extensionsâ—¶JoinLinesâ€¿(<âŸœ2â—¶ProcCommentâ€¿ProcHtml)

  dig â† '0'+â†•10
  [lineChars,lineClas,procFns] â† â‰[
    ""    â€¿ (!âˆ˜0)       â€¿ ProcParagraph
    "#"   â€¿ LenHeading  â€¿ ProcHeading
    ""    â€¿ 0           â€¿ ProcCode
    ""    â€¿ 0           â€¿ ProcTable
    "-+*" â€¿ LenBullet   â€¿ ProcBullet
  # dig   â€¿ LenListNum  â€¿ ProcListNum
    "<"   â€¿ IsHtmlBlock â€¿ ProcHtmlBlock
  ]

  ######
  # Inline elements
  ProcInline â† {
    I2M â† (â‰ ğ•©) â†‘ /â¼  # Index to mask
    punc â† ğ•© InRanges "!/:@[`{~"
    actual â† Â¬ punc âˆ§ IsEscaped ğ•©  # backtick or *actual* backtick?

    # Code spans
    tick â† ğ•© = '`'
    tend â† / >âŸœÂ« tick
    tcount â† CountRuns tick
    # ğ•¨ are tick lengths and ğ•© are positions, both sorted by length
    MatchTicks â† {
      # Tick runs other than the last of each length
      notLast â† =âŸœÂ« ğ•¨
      # Ticks preceded by backslashes can't start code blocks, but can
      # end them. This approach is wrong for multiple ticks with a
      # leading backslash in front, which are excluded but should just
      # be treated as one shorter when leading.
      filter â† notLast / (ğ•©Â¬ğ•¨) âŠ actual
      # For leading ticks, filter by not-last; for trailing ones, rotate
      # by Â¯1 to filter by not-first.
      (filter / âŒ½âŸœnotLast / ğ•©Ë™)Â¨ 0â€¿Â¯1
    }
    tlen â† tend âŠ tcount
    c â† TraceÂ´ tlen MatchTicksâ—‹((â‹tlen)âŠ¸âŠ) tend
    cl â† (âŠË˜c) âŠ tcount
    ctInds â† â¥ŠË˜ 1 + c -âŒœË˜ clÃ—âŒœ1â€¿0
    codeMask â† â‰ ` I2M â¥Š codeBounds â† 1â€¿2âŠ¸âŠË˜ ctInds
    ğ•© â†© ' 'Â¨âŒ¾((codeMaskâˆ§ğ•©=lf)âŠ¸/) ğ•©
    # If span has both a leading and a trailing space, they are removed.
    remSpace â† I2M â¥Š ((1<-ËœËË˜)âˆ§Â·âˆ§ËË˜' '=âŠâŸœğ•©)âŠ¸/ -âŸœ0â€¿1Ë˜ codeBounds
    codeMask âˆ§â†© Â¬ remSpace
    include â† Â¬ remSpace âˆ¨ â‰ ` I2M â¥Š ctInds
    codeBounds â†© â¥Š -âŸœ1â€¿0Ë˜ codeBounds
    unused â† actual âˆ§ include âˆ§ Â¬ codeMask

    # Links
    ProcLink â† {text ğ•Š target:
      t â† âˆ¾âŸ¨"a",{extensions?'â†’'â‰¡âŠ‘text?" class=""fulldoc""";""}
            " href=""",AdjustTarget â¥Štarget,""""âŸ©
      t Html ProcInline text
    }
    ghPath â† blobURLâˆ¾path
    AdjustTarget â† {
      # Adjust relative *.md links, and make other relative links
      # absolute (pointing to github.com instead of github.io).
      _replaceEnd â† {oldâ€¿newâ€¿subâ€¿default _r:
        (-â‰ old) (oldâ‰¡â†‘)â—¶âŸ¨default,subâˆ˜â†“âˆ¾newË™âŸ© âŠ¢
      }
      RI â† "README."â€¿"index."â€¿âŠ¢â€¿âŠ¢ _replaceEnd
      R â† "md"â€¿"html"â€¿RIâ€¿(ghPathâŠ¸âˆ¾) _replaceEnd
      # Exclude absolute links by testing for :
      # Don't do anything to fragments (trailing #sub-heading)
      (âŠ‘ğ•©âŠ"#") (RâŸ(Â¬ğ•©âˆ¨Â´âˆ˜=':')âŸ(0<â‰ )âˆ˜â†‘âˆ¾â†“) ğ•©
    }âŸextensions
    # Find matched-depth [] and () pairs, then join adjacent ones
    brak â† (unused âˆ§ ğ•©âŠ¸=)Â¨ "[]"â‰"()"
    FindPairs â† { # ğ•© is openâ€¿close masks
      ind â† / âˆ¨Â´ ğ•©     # Indices of all brackets
      open â† ind âŠ âŠ‘ğ•©  # Is a given bracket open?
      # The natural bracketing depth is one higher for open brackets
      # than closed ones. For ordering, adjust it to be the same by
      # subtracting one from open brackets.
      depth â† +` open-Â¬open
      order â† â‹ depth-open
      # A balanced pair is an open bracket and the next closed bracket
      # at the same depth. After ordering by ascending adjusted depth,
      # the natural depth, which is equal to the adjusted depth plus one
      # at each open bracket, can only decrease between two values if
      # they have the same depth and the first is open but the second
      # is closed: that is, if they form a balanced pair. 1âŠ¸â†‘âŠ¸Â»âŠ¸> gives
      # a mask for the second part of each such pair and Â«âŠ¸âˆ¨ extends it
      # to the first as well.
      hasPair â† Â«âŠ¸âˆ¨ 1âŠ¸â†‘âŠ¸Â»âŠ¸> orderâŠdepth
      âˆ˜â€¿2 â¥Š hasPair / orderâŠind
    }
    JoinPairs â† {
      eâ†1+1âŠË˜ğ•¨ â‹„ bâ†âŠË˜ğ•©  # Match end of ğ•¨ (plus one) with beginning of ğ•©
      mâ†(â‰ b)>iâ†bâŠe      # iâŠğ•© matches e where m is 1
      (m/ğ•¨) âˆ¾Ë˜ (m/i)âŠğ•©
    }
    # The four bracket indices for each link
    lInds â† JoinPairsâ—‹FindPairsË brak
    linkPos â† âŠË˜ lInds
    lInds +â‰1â†© 1â€¿0â€¿1â€¿0
    unused âˆ§â†© include âˆ§â†© notLink â† Â¬ â‰ ` I2M â¥Š (Â¯1â€¿1+0â€¿3âŠ¸âŠ)Ë˜ lInds
    linkGroup â† 1 -Ëœ (âŠ£Ã—>)â—‹(+`I2M)Â´ (â‰ âŠ¸â¥ŠâŸœâ†•âˆ¾âŠ¢)âŸœ2âŠ¸âŠ” â¥ŠlInds
    links â† â¥Š ProcLinkÂ¨ËË˜ âˆ˜â€¿2 â¥Š linkGroup âŠ” ğ•©

    # Code highlighting within a link was handled by ProcLink
    codeMask âˆ§â†© notLink
    âŸ¨code,codePosâŸ© â† codeMask extensionsâ—¶(â‹ˆËœâŸ¨âŸ©)â€¿GetMultiHighlights ğ•©
    codeBounds /Ëœâ†© codeBounds âŠ notLink

    # Emphasis (still rudimentary)
    eMasks â† (unused âˆ§ ğ•©âŠ¸=)Â¨ "*_"
    eMasks â†© Â«âŠ¸âˆ§Â¨âŠ¸(âŠ£âˆ¾ËœÂ»âŠ¸âˆ¨âŠ¸<Â¨) eMasks
    eInds â† (âŠ¢-2|âŠ¢)âˆ˜â‰ âŠ¸â†‘âˆ˜/Â¨ eMasks
    include âˆ§â†© Â¬ I2M âˆ§ âˆ¾ eIndsâˆ¾1+2â†“eInds
    eInds âˆ¾â†© âŸ¨codeBoundsâŸ©
    eTags â† âˆ¾ eInds â‰ âŠ¸â¥ŠÂ¨ 2â€¿2â€¿1 / ("<"â€¿"</"âˆ¾Â¨Â·<âˆ¾âŸœ">")Â¨ "em"â€¿"strong"â€¿"code"
    eInds âˆ¾â†©

    # Remove backslashes used for escaping
    include âˆ§â†© codeMask âˆ¨ 1 Â« actual

    emâ€¿entâ€¿ei â† include CharEntities ğ•©
    include âˆ§â†© em

    add â† âˆ¾âŸ¨eTags,ent,code,linksâŸ©         # Text to be added
    pos â† âˆ¾âŸ¨eInds,ei,codePos,linkPosâŸ©     # Where to add it
    âŸ¨include,add,posâŸ© Modify ğ•©
  }

  ######
  # Create the block structure using line classifications.

  lengths â† â‰ Â¨ ğ•©                   # Length of each line
  blanks â† (Lead ' 'âŠ¸=)Â¨ ğ•©         # Number of leading blanks
  nonEmptyMask â† blanks < lengths  # Empty â†â†’ all leading blanks

  # Get line classifications: type of line, and data to be passed into
  # the line processor. Note that leading blanks aren't passed in.
  lineTypeâ€¿lineDat â† <Ë˜â‰ > ClassifyLineÂ¨ blanks â†“Â¨ ğ•©
  # Empty lines have type Â¯1.
  lineType Â¯1Â¨âŒ¾((Â¬nonEmptyMask)âŠ¸/)â†©

  # Chase HTML comments
  commentStart â† /(lineType=5)âˆ§lineDat=2
  EndsComment â† âˆ¨Â´"-->"â·âŠ‘âŸœğ•©
  lastCommentEnd â† Â¯1
  comInd â† âˆ¾ comments â† {
    lastCommentEnd â†© end â† {ğ•ŠâŸ(Â¬EndsComment)1+ğ•©}âŸ(lastCommentEndâŠ¸<) ğ•©-1
    ğ•© + â†•endÂ¬ğ•©  # A list of indices
  }Â¨ commentStart
  newBlock â† (â‰ ğ•©)â†‘/â¼ âŠ‘Â¨ (0<â‰ Â¨)âŠ¸/ comments
  lineType 5Â¨âŒ¾(comIndâŠ¸âŠ)â†©
  lineDat  2Â¨âŒ¾(comIndâŠ¸âŠ)â†©

  # Lines that could be included in code blocks (will be refined)
  codeMask â† nonEmptyMask âˆ§ (lineType â‰  5) âˆ§ blanks â‰¥ 4
  paragraphMask â† 0 = lineType
  # A header can't have 4 spaces of indentation. If it doesn't become
  # part of a code block, it will be included in a paragraph.
  lineType -â†© codeMask âˆ§ 1 = lineType

  # Tables are made up of rows that would otherwise be paragraph rows.
  # They are indicated by the delimiter row, consisting of only a few
  # allowed characters, preceded (!) by a header row with the same
  # number of cells.
  IsTD â† (âˆ§Â´ âˆŠ âˆ¾ âŠ£ âˆŠËœ 2â†‘âŠ¢)âŸœ"-|: "
  tableMask â† (0âŒ¾âŠ‘ nonEmptyMask) âˆ§ paragraphMask âˆ§Â¬ codeMask
  tableDelimMask â† { ğ•© IsTDÂ¨âˆ˜âŠ£âŒ¾(ğ•¨âŠ¸/) ğ•¨ }âŸœğ•© tableMask
  delimValid â† (âŠ¢ =â—‹(â‰ âˆ˜âŠ”âˆ˜CutTableRowÂ¨ âŠâŸœğ•©) -âŸœ1) / tableDelimMask
  headerMask â† Â« delimValidâŒ¾(tableDelimMaskâŠ¸/) 0Â¨ğ•©
  tableMask â†© headerMask (âŠ¢ âˆ§ âŠ£ âˆ¨ âŠ£ PrecedesGroup <) tableMask
  lineType 3Â¨âŒ¾(tableMaskâŠ¸/)â†©

  # Code blocks consist of indented lines, possibly with blank lines
  # in between. They must be separated from paragraphs by blank lines.
  codeMask âˆ§â†© Â¬ paragraphMask PrecedesGroup codeMask
  codeMask âˆ¨â†© codeMask (âŠ¢ âˆ§ PrecedesGroup âˆ§ PrecedesGroupâŒ¾âŒ½) lineType < 0
  lineType 2Â¨âŒ¾(codeMaskâŠ¸/)â†©

  # List items continue over following indented lines
  listMask â† (0=blanks) âˆ§ 4 = lineType
  listIndent â† blanks â‰¥ Â»blanks + listMaskÃ—lineDat
  listMask â†© codeMask < listMask (âŠ£ PrecedesGroup <) listIndent
  lineType 4Â¨âŒ¾(listMaskâŠ¸/)â†©

  # Lines continue blocks if they are part of the same multi-line
  # type as the previous line, and otherwise start new ones.
  # Headers (type 1) always start new blocks.
  newBlock âˆ¨â†© 1 = lineType
  blockStart â† nonEmptyMask âˆ§ newBlock âˆ¨ Â¯1âŠ¸Â»âŠ¸â‰  lineType
  # Headers and paragraphs ignore leading blanks.
  drop â† blanks Ã— lineType < 2
  # Group blocks based on blockStart, with type Â¯1 lines excluded.
  blocks â† (1 -Ëœ (lineType â‰¥ 0) Ã— +`blockStart) âŠ” drop â†“Â¨ ğ•©

  # To process a block, pick the appropriate function from procFns.
  ProcBlock â† {tâ€¿l G b: fâ†tâŠ‘procFns â‹„ l F âŠ‘b }
  b â† (blockStart / lineTypeâ‰Ë˜lineDat) <âˆ˜ProcBlockË˜ blocks
  JoinLines b
}


################################
# Syntax highlighting

# Characters in identifiers. These are also used in ProcCode to detect
# if a statement is an assignment.
idChars â† âŸ¨
  ('0'+â†•10)âˆ¾"Â¯.Ï€âˆ"
  "ğ•£"âˆ¾Ëœ'a'+â†•26
  'A'+â†•26
  "_"
âŸ©

# Return BQN highlights for an string ğ•©, as an âŸ¨add,posâŸ© list for Modify
# (include will be all 1s).
# ğ•¨ indicates a character from ğ•© is a divider, which ends comments and
# can't be contained in string literals.
hlcharsâ€¿classTag â† {
  funcâ€¿mod1â€¿mod2 â† â€¢Import "src/glyphs.bqn"
  # Characters used by BQN, and the HTML class they are associated with.
  classesâ€¿chars â† <Ë˜ â‰ âˆ˜â€¿2â¥ŠâŸ¨
    0             , " "âˆ¾@+9â€¿10  # Should never be highlighted
    "Value"       , "ğ•¨ğ•©ğ•—ğ•˜ğ•¤"
    "Function"    , funcâˆ¾"ğ•ğ•ğ”½ğ”¾ğ•Š"
    "Modifier"    , mod1
    "Modifier2"   , mod2
    "Number"      , âˆ¾idChars       # Will be classified among â†‘â†‘ later
    "Gets"        , "â†â‡â†©â†’"
    "Paren"       , "()"
    "Bracket"     , "âŸ¨âŸ©[]"
    "Brace"       , "{}"
    "Head"        , ":;?"
    "Ligature"    , "â€¿"
    "Nothing"     , "Â·"
    "Separator"   , "â‹„,"
    "String"      , "'""@"
    "Comment"     , "#"
  âŸ©
  # Turn non-whitespace classes into âŸ¨open,closeâŸ© html tags.
  classTag â† ""â€¿"" âˆ¾ > {âŸ¨"<span class='"âˆ¾ğ•©âˆ¾"'>","</span>"âŸ©}Â¨ 1â†“classes
  charsâ€¿classTag
}

CommentStringLocations â† {
  c â† ğ•©='#'
  leâ† / (ğ•¨ âŠ¢âŠ˜âˆ¨ ğ•©=lf) âˆ¾ 1
  # Line endings (le) end every comment (/c) on the line, so take a copy
  # for each # before that line but not the previous.
  ceâ† le /Ëœ -âŸœÂ» c/âŠ¸â‹le
  # A single quote can only be used if there's another two places down.
  s â† /0â€¿0âŠ¸Â«âŠ¸âˆ§ğ•©='''
  d â† /ğ•©='"'
  css â† âˆ¾ âŸ¨ s   â‹„ Â¯1â†“d â‹„ /c âŸ© # Comment or string start
  cse â† âˆ¾ âŸ¨ 2+s â‹„  1â†“d â‹„ ce âŸ© # Corresponding end indices
  # If ğ•¨ is given, filter out strings with ends in different divisions.
  {cssâ€¿cse <âˆ˜=â—‹(âŠâŸœ(+`0âˆ¾ğ•©))Â´âŠ¸(/Â¨)â†©} ğ•¨
  # Table of (start,end) pairs
  b â† css Trace cse
  # Return the table, and a mask of which rows are comments
  âŸ¨b, (âŠË˜b)âŠcâŸ©
}
NotCommentOrString â† {
  iâ€¿c â† ğ•¨ CommentStringLocations ğ•©
  i +â†© (Â¬c) Ã—âŒœ 0â€¿1  # Strings include ending character; comments don't
  1 â‰ ` (â‰ ğ•©) â†‘ 2|/â¼â¥Ši
}

GetHighlights â† {
  # Find each character's group, sending unknowns to 1 and # to 0.
  col â† (1-Ëœâ‰ hlchars) (âŠ¢-âŠ£Ã—â‰¤) hlchars FindGroup ğ•©
  col-â†© 4Ã—(ğ•©='.')>Â«ğ•©âˆŠ'0'+â†•10 # Namespace dot: 5â†’1

  # Table of start/end pairs, and which are comments
  bâ€¿c â† ğ•¨ CommentStringLocations ğ•©
  # Given a list of pairs, get a mask indicating included regions
  ToMask â† (â‰ `âˆ¨âŠ¢) (â‰ ğ•©)â†‘/â¼âˆ˜âˆ¾
  # Split rows and group into textâ€¿comments
  tc â† c âˆ¾âŸœ2âŠ¸âŠ” <Ë˜b
  # Color with "String" and "Comment"
  col âŒˆâ†© +Â´ (2â€¿1-Ëœâ‰ classTag) Ã— ToMaskÂ¨ tc

  # Color numeric literals and identifiers
  id â† col=5                 # â†â†’ ğ•©âˆŠidChars
  w  â† Â»âŠ¸< id                # Word (identifier or number) beginning mask
  wt â† idChars FindGroup w/ğ•© # Type based on first character
  wt+â†© '_' = (Â«âŠ¸<id)/ğ•©       # Modifier1 to Modifier2 based on word end
  wt+â†© 5Ã—0=wt                # Shift 0 to Number
  wi â† 1-Ëœ+`id/w             # Index of word containing each of /id
  colâ†© (wiâŠwt)âŒ¾(idâŠ¸/) col
  # And the system dot
  colâ†© (Â«col) âŠ£âŒ¾((idÂ«âŠ¸âˆ§ğ•©='â€¢')âŠ¸/) col

  # Tags are placed at boundaries between different colors
  boundary â† (Â»ğ•¨) âŠ¢âŠ˜âˆ¨ Â¯1âŠ¸Â»âŠ¸â‰  col
  bcol â† boundary / col
  # Windows gives us rows of start,end where the end position of one
  # color is the start of the next
  # Subtract one to place before the starting character
  bp  â† 1-Ëœ/boundaryâˆ¾1
  # Comments naturally end on dividers but need to stop before them
  pos â† (-0â€¿1âˆ§âŒœËœ(1â†“bp)âŠğ•¨) + 2â†•bp
  # Remove class 0 regions, as these don't use tags
  (â¥Š (0<bcol)âŠ¸/)Â¨ âŸ¨bcolâŠclassTag, posâŸ©
}

# Return highlights for areas in ğ•© where ğ•¨ is true.
# Highlights all regions at once with a ' ' divider before each.
GetMultiHighlights â† {
  Â¬âˆ¨Â´ğ•¨ ? â‹ˆËœâŸ¨âŸ© ;      # No code â†’ no highlights
  mask â† Â«âŠ¸âˆ¨ ğ•¨       # Places to highlight, including dividers
  div  â† Â¬ mask / ğ•¨  # Indicate the dividers
  câ€¿pos â† div GetHighlights ' 'Â¨âŒ¾(divâŠ¸/) mask / ğ•©
  # Add an adjustment that expands dividers back to original size
  adj â† div ((1-Ëœâ‹âŸœpos) âŠ -Ëœ)â—‹/ mask > ğ•¨
  âŸ¨c, pos + adjâŸ©
}


################################
# Creating HTML files
ConvertFile â† {
  MatchStartâ€¿MatchEnd â† { â‰¤â—‹â‰ â—¶0â€¿(âŠ£ â‰¡ (ğ•©Ã—â‰ )âŠ¸â†‘) }Â¨ 1â€¿Â¯1

  âŸ¨"Input file ",ğ•©," is not markdown (*.md)"âŸ© âˆ¾âŠ¸! ".md" MatchEnd ğ•©
  fileout â† ".html" âˆ¾Ëœ (Â¯6âŠ¸â†“âˆ¾"index"Ë™)âŸ("README"âŠ¸MatchEnd) Â¯3â†“ğ•©

  # Contents of file to convert
  md â† â€¢file.Lines ğ•©
  # Verify and remove the html link line: the output *is* the html file.
  IsView â† "*View this file"âŠ¸MatchStart âˆ§ (siteURLâˆ¾fileoutâˆ¾").*")âŠ¸MatchEnd
  âŸ¨"File ",ğ•©," has missing or incorrect view link"âŸ© âˆ¾âŠ¸! IsView âŠ‘md
  out â† ğ•© Markdown 2â†“md

  parts â† (1-ËœÂ·(Â¬Ã—1++`)'/'âŠ¸=)âŠ¸âŠ” (âŠ‘âŠâŸœ".")âŠ¸â†‘ ğ•©
  root â† âŠ‘ up â† â¥Šâˆ˜/âŸœâ‰âŸœ"../"Â¨ âŒ½â†•â‰ parts
  isInd â† "README" â‰¡ Â¯1âŠ‘parts
  RQ â† {'"'Â¨âŒ¾(('''=ğ•©)âŠ¸/)ğ•©}
  Link â† RQ {âˆ¾âŸ¨"<link href='",root,ğ•©,"' rel='",ğ•¨,"'/>"âŸ©}
  Clean â† "`` ` ``"âŠ¸â· âˆ¨Â´âˆ˜âŠ£â—¶âŸ¨'`'âŠ¸â‰ âŠ¸/âŠ¢,â‰ âŠ¸(1â‰ `-âŠ¸â†‘â‰ â†‘)Ëœ/âŠ¢âŸ© âŠ¢  # Help pages have backticks in titles
  h1 â† (2â‰¤â‰ )â—¶0â€¿("# "â‰¡2âŠ¸â†‘)Â¨âŠ¸/md
  "Wrong number of titles in "â€¿ğ•© âˆ¾âŠ¸! 1=â‰ h1
  head â† "head" Html lfâˆ¾JoinLines "  "âŠ¸âˆ¾Â¨âŸ¨
    RQ "<meta charset='utf-8'>"
    "shortcut icon' type='image/x-icon" Link "favicon.ico"
    "stylesheet" Link "style.css"
    "title" Html ("BQN"âˆ¾":"âŠ¸(Â¬âˆ˜âˆŠ/âŠ£)âˆ¾" "âˆ¾âŠ¢)âŸ(Â¬Â·âˆ¨Â´"BQN"â·âŠ¢) Clean 2â†“âŠ‘h1
  âŸ©
  repo â† "("âˆ¾")"âˆ¾Ëœ "a href='"â€¿repoURLâ€¿"'" âˆ¾âŠ¸Html "github"
  crumbs â† up ("a href='"âˆ¾âˆ¾âŸœ"index.html'")âŠ¸HtmlÂ¨â—‹((-isInd)âŠ¸â†“) (<"BQN")Â»parts
  nav â† RQ "div class='nav'" Html 3â†“âˆ¾ " / "âŠ¸âˆ¾Â¨ repo <âŠ¸âˆ¾ crumbs
  front â† head âˆ¾â—‹(âˆ¾âŸœlf) nav
  ("docs/"âˆ¾fileout) â€¢file.Chars front âˆ¾ out
}

ConvertFileÂ¨ â€¢args

Markdown  # Used by tester test/markdown.bqn
