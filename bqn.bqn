#! /usr/bin/env bqn

# A BQN interpreter implemented in BQN
# ./bqn.bqn ( files | -e source )

# Unlike a compiler, a self-hosted interpreter is kind of silly. This
# script is mostly just evidence that the BQN components found in this
# repository do add up to a full implementation. The same idea more
# usefully applied in test/unit.bqn, which can build an interpreter
# using some or all of them in order to test it.

# BQN's compiler is truly self-hosting, but targets a BQN-specific
# object code rather than machine code (as does Java). The virtual
# machine interprets this object code. Finally, the compiler takes
# primitive values as input in order to include them in the object code.
# As all primitives are available in BQN we could just use these, but
# for more self-hostingness the BQN-based runtime is used instead, so
# that the interpreter relies on a smaller set of core functions.

#âŒœ
# Assemble the components
gl â† â€¢Import "src/glyphs.bqn"
compile â† gl â€¢Import "src/c.bqn"  # Compiler: source â†’ object code
vm      â†    â€¢Import "vm.bqn"     # VM: interprets object code
runtime â†    â€¢Import "rt.bqn"     # Runtime: primitives available to VM

# Define system values later, to include BQN
BQN â† âŸ¨runtime, {System ğ•©}âŸ© âŠ¸ (VM Compile)

#âŒœ
# System values
IsPrim â† âˆŠâŸœruntimeâŒ¾<
Glyph â† runtimeâŠ¸âŠâŒ¾<âŠ‘(âˆ¾gl)Ë™
Decompose â† IsPrimâ—¶âŸ¨â€¢Decompose,0âŠ¸â‰âŸ©

# Formatter
tn â† "*"âŠ¸(âˆ¾âˆ¾âŠ£)Â¨"array"â€¿"function"â€¿"1-modifier"â€¿"2-modifier"â€¿"namespace"
Fmtâ€¿Repr â† (â€¢Import "src/f.bqn"){ğ”½} âŸ¨
  â€¢Type
  Decompose
  IsPrimâ—¶âŸ¨tnâŠ‘Ëœâ€¢Type-2Ë™, GlyphâŸ© # Format operation/namespace
  â€¢Repr                        # Format number
âŸ©
Show â† â€¢Outâˆ˜FmtâŠ¸âŠ¢âŠ¢

# Lookup table
FindSys â† {
  i â† ğ•¨âŠğ•©
  { ! âˆ¾âŸ¨"Unknown system value",(1â‰ â‰ ğ•©)/"s",":"âŸ©âˆ¾" â€¢"âŠ¸âˆ¾Â¨ğ•© }âˆ˜/âŸœğ•©âŸ(âˆ¨Â´) i=â‰ ğ•¨
  i
}
system â† {ğ•¨âŠ¸FindSysâŠğ•©Ë™}Â´âŸ¨
  "bqn"â€¿"type"â€¿"glyph"â€¿"decompose"â€¿"repr"â€¿"fmt"â€¿"out"â€¿"show"
   BQN â€¿â€¢Type â€¿ Glyph â€¿ Decompose â€¿ Repr â€¿ Fmt â€¿â€¢Out â€¿ Show
âŸ©

#âŒœ
# Evaluate
{
  0 < â‰ â€¢args ?
  t â† âŠ‘ "-e"â€¿"-p" âŠ âŠâ€¢args
  ShowâŸ(t=1)âˆ˜BQNÂ¨ (t<2)â—¶âŸ¨â€¢file.CharsÂ¨, 1âŠ¸â†“âŸ© â€¢args
;@}

BQN  # Return the evaluator so it can be â€¢Include d from BQN
