#!/usr/bin/env dbqn

# This version of dzref defines every primitive that spec/reference.bqn
# does. It's intended to test out these implementations for use in the
# BQN runtime; use plain dzref if you just want to run BQN as it's much
# faster and supports inverses better.

impl â† â€¢LNS "impl.bqn"

Xâ†Rawâ†{â‰¤4}
{
  chrsâ†âŸ¨
    "!+-Ã—Ã·â‹†âˆšâŒŠâŒˆâˆ§âˆ¨Â¬|=â‰ â‰¤<>â‰¥â‰¡â‰¢âŠ£â¥Šâˆ¾â‰â†‘â†“â†•âŒ½â‰/â‹â’âŠâŠ‘âŠâŠ’âˆŠâ·âŠ”"
    "ËœË˜Â¨âŒœâ¼Â´Ë`"
    "âˆ˜âŠ¸âŸœâ—‹âŒ¾â‰âš‡âŸâ—¶âŠ˜"
  âŸ©
  nc â† â‰ Â¨chrs
  chr â† âˆ¾chrs
  itr â† 0â¥ŠËœâ‰ chr

  init â† " "âŠ¸âˆ¾Â¨(/âŸœ"_"Â¨nc/0â€¿1â€¿1)âˆ¾Â¨(nc/"FMD")âˆ¾Â¨(nc+Â´âŠ¸â†‘â¥Š"ABC"âˆ¾âŒœâ€¢a)
  post â† âˆ¾âŸœ" "Â¨/âŸœ"_"Â¨nc/0â€¿0â€¿1
  names â† initâˆ¾Â¨(â€¢UCS 48)âˆ¾Â¨post

  Inc â† {
    iâ†âŠ‘chrâŠğ•©
    nâ†0 â‹„ itrâ†©{nâ†©1+ğ•©}âŒ¾(iâŠ‘âŠ¢)itr
    namesâ†©((iâŠ‘init)âˆ¾(â€¢UCS 48+n)âˆ¾iâŠ‘post)âŒ¾(iâŠ‘âŠ¢)names
  }

  # built-in assumptions
  Mod â† {((âŠ‘chrâŠğ•¨)âŠ‘names) âˆ¾ " â† " âˆ¾ ğ•©}

  âÂ¨ âŸ¨
    "IsArray â† 0â‰ â‰¡"
    "_amend  â† {ğ•¨{ğ•©â‹„ğ•—}âŒ¾(ğ•—âŠ‘âŠ¢)ğ•©}"
    "Type    â† âŸ¨âŸ©â¥Š0âŠ¸â¥Š"
    '!' Mod "{ğ•© â‹„ â‰¤1}âŸÂ¬"
  âŸ©âˆ¾ModâŸœâ¥ŠÂ¨ "+-Ã—Ã·â‹†âŒŠ=â‰¤â‰¢â¥ŠâŠ‘â†•âŒœâ¼"


  # checks if line is a builtin redefinition
  E_isdef â† (3â‰¤â‰ )â—¶âŸ¨0,âˆ§Â´âŸ¨chr," ","â†â†©"âŸ©âˆŠËœÂ¨3âŠ¸â†‘âŸ©

  # removes comments and replaces built-ins with names
  E_proc â† {
    lâ†â‰ chr
    qâ†â‰ `ğ•©âˆŠ"""'" â‹„ fâ†Â¬âˆ¨`qÂ¬âŠ¸âˆ§ğ•©='#'
    âˆ¾ (((lÃ—f/q)+chrâŠ¸âŠ) (â‰¥âŸœl)â—¶âŸ¨âŠ‘âŸœnames,â¥Šâˆ˜âŠ¢âŸ©Â¨ âŠ¢) f/ğ•©
  }

  E_redef â† { # handles [fmd] [â†â†©]
    tail â† E_proc 3â†“ğ•© # must use old def
    Inc âŠ‘ğ•©
    (E_proc 1â†‘ğ•©) âˆ¾ "â†" âˆ¾ tail
  }

  lf â† â€¢UCS 10
  pre â† E_isdefâ—¶E_procâ€¿E_redefÂ¨ impl
  Rawâ†©â
  ExecFileâ†{Raw âˆ¾ âˆ¾âŸœlfÂ¨ E_procÂ¨ â€¢LNS ğ•©}
  Xâ†©Rawâˆ˜E_proc
  â âˆ¾ âˆ¾âŸœlfÂ¨ pre
  â‰ â—¶Xâ€¿{ExecFile âŠ‘ğ•©}â€¿{ExecFile âŠ‘ğ•© â‹„ X 1âŠ‘ğ•©} â€¢args
}0
