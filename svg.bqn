# Utilities for creating SVG diagrams as strings

# Snag the code highlighter from md.bqn
Highlight â† {
  AddT â† (â†‘âˆ¾"t"âˆ¾â†“)Â¨ËœâŸœ(1â€¿2â¥ŠËœâ‰¢)âŸ(ğ•¨âŠ£1)  # span to tspan
  (1Â¨ <âŠ¸âˆ¾ Â·AddTâŒ¾âŠ‘GetHighlights)âŠ¸Modify ğ•©
}

IsLines â† 1<â‰¡
DeNest â† {(3âŒŠâ‰¡)â—¶âŸ¨!âˆ˜0,â¥Š<,âŠ¢,âˆ¾ğ•ŠÂ¨âŸ© â¥Šğ•©}
Indent â† "  "âŠ¸âˆ¾Â¨ DeNest

# Create a node from a tag name and interior text.
Enc â† {
  open â† âˆ¾âŸ¨"<",ğ•¨,">"âŸ©
  closeâ† âˆ¾âŸ¨"</", (âŠ‘ğ•¨âŠ" ")â†‘ğ•¨, ">"âŸ©
  l â† IsLines ğ•©
  âˆ¾ open (IndentâŸl ğ•©){ğ•¨â€¿ğ•—â€¿ğ•©}â—‹(â¥Šâˆ˜<âŸl) close
}
Void â† {âˆ¾âŸ¨"<",ğ•©,"/>"âŸ©}

FmtNum â† {
  ! 0=â‰¡ğ•©
  ! (Â¯âˆâŠ¸< âˆ§ <âŸœâˆ) ğ•©
  d â† 3 â‹†Ëœ bâ†10            # Base 10, up to 3 decimals
  _base â† {âŒ½b|âŒŠâˆ˜Ã·âŸœbâŸ(â†•ğ”½)}  # ğ”½ is the number of digits
  fl â† âŒŠ abs â† (Ã·2Ã—d) + |ğ•©
  âˆ¾ âŸ¨
    (ğ•©<0) / "-"
    '0' + (1+Â·âŒŠbâ‹†â¼1âŒˆâŠ¢)_base fl
    0âŠ¸<â—¶""â€¿("." âˆ¾ '0' + Â· âˆ¨`âŒ¾âŒ½âˆ˜Ã—âŠ¸/ 3 _base) âŒŠ d Ã— abs-fl
  âŸ©
}
Fmt â† (2âŒŠâ‰¡)â—¶FmtNumâ€¿(1â†“Â·âˆ¾(' 'âˆ¾FmtNum)Â¨)â€¿{ğ•©â‹„!0}

At1 â† " " âˆ¾ {âˆ¾âŸ¨ğ•¨,"='",ğ•©,"'"âŸ©}Â´
Attr â† âˆ¾âŸœ(âˆ¾ <âˆ˜At1â‰1)
At â† {
  _s â† {((+`Ã—Â¬)âŠ¸-ğ•—âŠ¸=)âŠ¸âŠ”}
  ğ•¨ >âŠ˜(âˆ¾âŸœ(âˆ¾At1Â¨)) '='_sÂ¨ '|'_s ğ•©
}
Pos â† âŸ¨"x","y"âŸ© â‰Ë˜ FmtNumÂ¨
Elt â† Voidâˆ˜Attr

SVG â† {
  (âˆ¾âˆ¾âŸœ(10+@)Â¨)âŸIsLines ("svg" Attr âŸ¨"viewBox",Fmt ğ•¨âŸ©) Enc ğ•©
}
