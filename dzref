#!/usr/bin/env dbqn

impl â† "
#âŒœ
# LAYER 4: Operators

ValidateRanksâ†{
  ! 1â‰¥=ğ•©
  ğ•©â†©â¥Šğ•©
  ! (1âŠ¸â‰¤âˆ§â‰¤âŸœ3)â‰ ğ•©
  ! âˆ§Â´âŒŠâŠ¸=âŒœğ•©
  ğ•©
}
_ranks â† {âŸ¨2âŸ©âŠ˜âŸ¨1,0âŸ© ((âŠ£-1+|)ËœâŸœâ‰ âŠ‘Â¨<âˆ˜âŠ¢) ValidateRanksâˆ˜ğ”½}
_depthOp_â†{
  negâ†0>nâ†ğ•¨ğ”¾_ranksğ•© â‹„ Fâ†ğ”½
  _dâ†{
    Râ†(ğ•—+neg)_d
    ğ•¨(2â¥Š(negâˆ§ğ•—â‰¥0)âˆ¨(0âŒˆğ•—)â‰¥â‰â—‹<â—‹â‰¡)â—¶(âŸ¨RÂ¨â‹„RâŸœğ•©Â¨âˆ˜âŠ£âŸ©â‰âŸ¨(ğ•¨RâŠ¢)Â¨âˆ˜âŠ¢â‹„FâŸ©)ğ•©
  }
  ğ•¨ n _d ğ•©
}
âš‡ â† _depthOp_


#âŒœ
# LAYER 5: Structural functions

Windowsâ†{
  Natâ†(1=â€¢Type)â—¶âŸ¨0,0âŠ¸â‰¤âˆ§âŒŠâŠ¸=âŸ©
  ! 0=â€¢Type ğ•©
  ! 1â‰¥=ğ•¨
  ! ğ•¨â‰¤â—‹â‰ â‰¢ğ•©
  ! âˆ§Â´NatÂ¨â¥Šğ•¨
  sâ†(â‰ ğ•¨)â†‘â‰¢ğ•©
  ! âˆ§Â´ğ•¨â‰¤1+s
  ğ•¨{(âˆ¾âŸœ(ğ•¨â‰ âŠ¸â†“â‰¢ğ•©)âˆ˜â‰¢â¥Š>)<Â¨âŠ¸âŠâŸœğ•©Â¨s(Â¬+âŒœâ—‹â†•âŠ¢)â¥Šğ•¨}âŸ(0<â‰ ğ•¨)ğ•©
}
â†• â†© â†•              âŠ˜ Windows


#âŒœ
# LAYER 6: Everything else

# Searching
IndexOfâ†(1<âŒˆâ—‹=)â—¶âŠâ€¿{
  câ†1-Ëœ=ğ•¨
  ! 0â‰¤c
  ğ•¨ (0<â‰ ğ•¨)â—¶âŸ¨0â‰câˆ˜âŠ¢,(+Ëâˆ§`)â‰¢â‰câ‰câ€¿âˆâŸ© ğ•©
}
MarkFirstâ†{
  ! 1â‰¤=ğ•©
  uâ†0â†‘ğ•©
  {(â‰ u)>âŠ‘u IndexOf ğ•©}â—¶{uâ†©uâˆ¾ğ•©â‹„1}â€¿0Ë˜ğ•©
}
Findâ†{
  râ†=ğ•¨
  ! râ‰¤=ğ•©
  ğ•¨ â‰¡â‰r ((1+r-âŠ¸â†‘â‰¢ğ•©)âŒŠâ‰¢ğ•¨)âŠ¸â†•â‰r ğ•©
}

âŠ â†© âŠ              âŠ˜ IndexOf
âˆŠ â† MarkFirst      âŠ˜ (âŠËœ<â‰ âˆ˜âŠ¢)
â· â† âˆŠâŠ¸/            âŠ˜ Find

OccurrenceCount â† âŠËœ(âŠ¢-âŠ)â‹âˆ˜â‹
ProgressiveIndexOf â† {ğ•¨âŠâ—‹(â‰Ë˜âŸœOccurrenceCountğ•¨âŠ¸âŠ)ğ•©}

âŠ’ â† OccurrenceCountâŠ˜ ProgressiveIndexOf
"

raw â† {â€¢Eval}
X â† {F:â‰¤4}
_withRef â† Ë™
{v:
  chrsâ†âŸ¨
    "â†•âŠâŠ’âˆŠâ·"
    ""
    "âš‡"
  âŸ©

  # built-in assumptions
  GetRepls â† {
    câ€¿n â† ğ•© â‹„ kâ†"â†•âŠ"
    âŸ¨c,(â¥ŠÂ¨k)âŒ¾(((âŠ‘Â¨c)âŠk)âŠ¸âŠ)nâŸ© âˆ¾âŸœ<Â¨ âŸ¨"â€¢Eval","(â€¢Eval _withRef)"âŸ©
  }

  âŸ¨E_proc,E_nodefâŸ© â† chrsâ€¿GetRepls â€¢Import "src/pp.bqn"

  lf â† @+10
  pre â† E_procÂ¨ lf((âŠ¢-ËœÂ¬Ã—+`)âˆ˜=âŠ”âŠ¢)impl
  ExecFileâ†{
    src â† E_nodefÂ¨ â€¢FLines ğ•©
    âŸ¨âŸ¨âŸ©,"",(âˆ¨`âŒ¾âŒ½'/'=ğ•©)/ğ•©âŸ© Raw âˆ¾ âˆ¾âŸœlfÂ¨ src
  }
  _withRef â†© {ğ”½âˆ˜E_nodefâŠ˜(ğ”½âŸœE_nodef)}
  Xâ†©Raw _withRef
  Raw âˆ¾ âˆ¾âŸœlfÂ¨ pre
  â‰ â—¶(XË™)â€¿{ExecFile âŠ‘ğ•©}â€¿{ExecFile âŠ‘ğ•© â‹„ X 1âŠ‘ğ•©} â€¢args
}
