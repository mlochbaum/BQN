#!/usr/bin/env dbqn

# Process BQN runtime
# r.bqn begins with provided values and defines primitives as it goes.
# Defining a primitive shadows previous definitions, so earlier uses
# of the primitive still use the old definition.
# This is handled by using a new name each time it's defined.

# All primitives
chrsâ†âŸ¨
  "+-Ã—Ã·â‹†âˆšâŒŠâŒˆ|Â¬âˆ§âˆ¨<>â‰ =â‰¤â‰¥â‰¡â‰¢âŠ£âŠ¢â¥Šâˆ¾â‰â†‘â†“â†•Â«Â»âŒ½â‰/â‹â’âŠâŠ‘âŠâŠ’âˆŠâ·âŠ”!"
  "Ë™ËœË˜Â¨âŒœâ¼Â´Ë`"
  "âˆ˜â—‹âŠ¸âŸœâŒ¾âŠ˜â—¶â‰âš‡âŸ"
âŸ©
nc â† â‰ Â¨chrs
glyphs â‡ chr â† âˆ¾chrs

# Provided values, to be passed in through the constants array
def â† âŸ¨"Type","Decompose","Glyph","Fill","Log","GroupLen","GroupOrd","_fillBy_"âŸ©
keep â† "!+-Ã—Ã·â‹†âŒŠ=â‰¤â‰¢â¥ŠâŠ‘â†•âŒœ`âŠ˜"
len â‡ def+â—‹â‰ keep
ki â† chrâŠkeep
dt â† âŠ”âŸœâŠ’ (+Â´Â·âˆ§`'_'=0â€¿Â¯1âŠ¸âŠ)Â¨ def
ns â† Â» neâ†+`nc
kt â† âˆ¾ (ns+â‰ Â¨dt) + âŠ”âŸœâŠ’neâ‹ki

# Initial primitive replacement names
init â† (nc/(' 'âˆ¾Â¨1â€¿2/â†‘"_")âˆ¾Â¨"FMD")âˆ¾Â¨('A'+nc+Â´âŠ¸â†‘â¥Š3âˆ¾âŒœâ—‹â†•26)
post â† nc/(2â€¿1/â†‘"_")âˆ¾Â¨' '
pn â† initâˆ¾Â¨'0'âˆ¾Â¨post

# All replacements: input and output
chrt â† â¥ŠÂ¨chr
in  â† chrt                 âˆ¾ def
out â† ((ktâŠchrt)âŒ¾(kiâŠ¸âŠ)pn) âˆ¾ (âˆ¾ns+dt)âŠchrt
# Make a new name for primitive ğ•©
itr â† 0â¥ŠËœâ‰ chr
Shadow â† {
  iâ†âŠ‘chrâŠğ•©
  nâ†0 â‹„ itrâ†©{nâ†©1+ğ•©}âŒ¾(iâŠ‘âŠ¢)itr
  outâ†©((iâŠ‘init)âˆ¾('0'+n)âˆ¾iâŠ‘post)âŒ¾(iâŠ‘âŠ¢)out
}

# Does the expression define a primitive?
E_isdef â† (3â‰¤â‰ )â—¶âŸ¨0,âˆ§Â´âŸ¨chr," ","â†â†©"âŸ©âˆŠËœÂ¨3âŠ¸â†‘âŸ©
# Process ordinary expression
E_nodef â† {
  idChars â† "_Â¯.Ï€âˆ"âˆ¾âˆ¾"0aA"+âŸœâ†•Â¨10â€¿26â€¿26
  qâ†â‰ `ğ•©='"' â‹„ qâˆ¨â†©â‰ `q<ğ•©=''' â‹„ fâ†Â¬âˆ¨`q<ğ•©='#'  # Quotes and comments
  t â† (Â¯1+`Â·Â¬(Â»f/q)âˆ¨Â·Â»âŠ¸âˆ§âˆŠâŸœidChars)âŠ¸âŠ” f/ğ•©   # Tokenize
  âˆ¾ (inâŠ¸âŠ âŠ‘âŸœoutâŸ(<âŸœ(â‰ in))Â¨ âŠ¢) t            # Replace
}
# Process expression, possibly redefining a primitive
E_proc â† E_isdefâ—¶E_nodefâ€¿{
  tail â† E_proc 3â†“ğ•©                        # RHS
  Shadow âŠ‘ğ•©                                # New name
  (E_proc 1â†‘ğ•©) âˆ¾ "â†" âˆ¾ tail                # LHS
}

rslt â† "âŸ¨"âˆ¾"âŸ©"Â«âˆ¾","âŠ¸âˆ¾Â¨chrt  # Output all primitives
ref â‡ âˆ¾âˆ¾âŸœ(@+10)Â¨ E_procÂ¨ (â€¢FLines "r.bqn")âˆ¾<rslt
