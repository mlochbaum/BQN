#!/usr/bin/env dbqn

# Process BQN runtime

impl â† â€¢FLines "r.bqn"

chrsâ†âŸ¨
  "+-Ã—Ã·â‹†âˆšâŒŠâŒˆ|Â¬âˆ§âˆ¨<>â‰ =â‰¤â‰¥â‰¡â‰¢âŠ£âŠ¢â¥Šâˆ¾â‰â†‘â†“â†•Â«Â»âŒ½â‰/â‹â’âŠâŠ‘âŠâŠ’âˆŠâ·âŠ”!"
  "Ë™ËœË˜Â¨âŒœâ¼Â´Ë`"
  "âˆ˜â—‹âŠ¸âŸœâŒ¾âŠ˜â—¶â‰âš‡âŸ"
âŸ©
nc â† â‰ Â¨chrs
glyphs â‡ chr â† âˆ¾chrs
itr â† 0â¥ŠËœâ‰ chr

idChars â† "_Â¯.Ï€âˆ"âˆ¾âˆ¾"0aA"+âŸœâ†•Â¨10â€¿26â€¿26

init â† " "âŠ¸âˆ¾Â¨(/âŸœ"_"Â¨nc/0â€¿1â€¿1)âˆ¾Â¨(nc/"FMD")âˆ¾Â¨(nc+Â´âŠ¸â†‘â¥Š"ABC"âˆ¾âŒœâ€¢a)
post â† âˆ¾âŸœ" "Â¨/âŸœ"_"Â¨nc/0â€¿0â€¿1
out â† initâˆ¾Â¨'0'âˆ¾Â¨post

Inc â† {
  iâ†âŠ‘chrâŠğ•©
  nâ†0 â‹„ itrâ†©{nâ†©1+ğ•©}âŒ¾(iâŠ‘âŠ¢)itr
  outâ†©((iâŠ‘init)âˆ¾('0'+n)âˆ¾iâŠ‘post)âŒ¾(iâŠ‘âŠ¢)out
}

# Required functionality passed in as an argument
def â† âŸ¨"Type","Decompose","Glyph","Fill","Log","GroupLen","GroupOrd","_fillBy_"âŸ©
keep â† "!+-Ã—Ã·â‹†âŒŠ=â‰¤â‰¢â¥ŠâŠ‘â†•âŒœ`âŠ˜"
len â‡ def+â—‹â‰ keep
ki â† chrâŠkeep
dt â† âŠ”âŸœâŠ’ (+Â´Â·âˆ§`'_'=0â€¿Â¯1âŠ¸âŠ)Â¨ def
ns â† Â» neâ†+`nc
kt â† âˆ¾ (ns+â‰ Â¨dt) + âŠ”âŸœâŠ’neâ‹ki

chrt â† â¥ŠÂ¨chr
in  â† chrt                  âˆ¾ def
out â†© ((ktâŠchrt)âŒ¾(kiâŠ¸âŠ)out) âˆ¾ (âˆ¾ns+dt)âŠchrt

E_isdef â† (3â‰¤â‰ )â—¶âŸ¨0,âˆ§Â´âŸ¨chr," ","â†â†©"âŸ©âˆŠËœÂ¨3âŠ¸â†‘âŸ©
E_proc â† {
  qâ†â‰ `ğ•©='"' â‹„ qâˆ¨â†©â‰ `q<ğ•©=''' â‹„ fâ†Â¬âˆ¨`q<ğ•©='#'
  t â† (Â¯1+`Â·Â¬(Â»f/q)âˆ¨Â·Â»âŠ¸âˆ§âˆŠâŸœidChars)âŠ¸âŠ” f/ğ•©
  âˆ¾ (inâŠ¸âŠ âŠ‘âŸœoutâŸ(<âŸœ(â‰ in))Â¨ âŠ¢) t
}
E_redef â† { # handles [fmd] [â†â†©]
  tail â† E_proc 3â†“ğ•© # must use old def
  Inc âŠ‘ğ•©
  (E_proc 1â†‘ğ•©) âˆ¾ "â†" âˆ¾ tail
}

ref â‡ âˆ¾âˆ¾âŸœ(@+10)Â¨ E_isdefâ—¶E_procâ€¿E_redefÂ¨ implâˆ¾<"âŸ¨"âˆ¾"âŸ©"Â«â¥Š","âŠ¸âˆ¾Ë˜chr
