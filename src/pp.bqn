# Primitive processor
# Used in dzref and pr.bqn for handling source code with primitive
# redefinitions.
# Defining a primitive shadows previous definitions, so earlier uses
# of the primitive still use the old definition.
# This is handled by using a new name each time it's defined.

âŸ¨chrs, GetReplacementsâŸ© â† â€¢args
nc â† â‰ Â¨chrs
chr â† âˆ¾chrs

# Initial primitive replacement names
init â† (nc/(' 'âˆ¾Â¨1â€¿2/â†‘"_")âˆ¾Â¨"FMD")âˆ¾Â¨('A'+nc+Â´âŠ¸â†‘â¥Š3âˆ¾âŒœâ—‹â†•26)
post â† nc/(2â€¿1/â†‘"_")âˆ¾Â¨' '
pn â† initâˆ¾Â¨'0'âˆ¾Â¨post

# All replacements: input and output
âŸ¨in,outâŸ© â† GetReplacements âŸ¨â¥ŠÂ¨chr,pnâŸ©

# Number of redefinitions so far, minus one
itr â† Â¯1â¥ŠËœâ‰ in

lfâ†@+10
Tokenizeâ†{
  wcâ†"_Â¯.Ï€âˆ"âˆ¾âˆ¾"0aA"+âŸœâ†•Â¨10â€¿26â€¿26             # Word characters

  # Resolve comments and strings
  sâ€¿dâ†/Â¨2â†‘smâ€¿dmâ€¿câ€¿nâ†ğ•©âŠ¸=Â¨"'""#"âˆ¾lf
  gâ†â‹qâ†âˆ¾âŸ¨  sâ‹„Â¯1â†“dâ‹„/câŸ© â‹„qâ†©gâŠq                # Open indices
  eâ† gâŠâˆ¾âŸ¨2+sâ‹„ 1â†“dâ‹„-âŸœÂ»âˆ˜âŠâŸœ(0âˆ¾+`c)âŠ¸//nâˆ¾1âŸ©      # Matching close indices
  Seâ†{(âŠËœğ•¨)Se 1Â¨âŒ¾((ğ•©/ğ•¨)âŠ¸âŠ)ğ•©}âŸ(0=Â¯1âŠ‘âŠ¢)       # Mark reachable openings
  abâ†âˆ¨Â´((â‰ ğ•©)â†‘Â·/â¼((â‰ â†‘âˆ¾âŸœâ‰ Se 1âˆ¾0Â¨)qâ‹e)âŠ¸/)Â¨qâ€¿e  # Open/close masks

  kâ†Â»â‰ `ab                                   # Token continuation mask
  kâˆ¨â†©Â»âŠ¸âˆ§k<ğ•©âˆŠwc                              # Group words
  kâˆ¨â†©Â»ğ•©='â€¢'
  (Â¯1+`Â¬k)âŠ”ğ•©
}

E_proc_sub â† {tokâ†ğ•©
  spec â† âŸ¨in, â¥ŠÂ¨lfâˆ¾",â‹„", â¥ŠÂ¨"â†â†©"âŸ©
  tt â† spec (+`â‰ Â¨)âŠ¸â‹ ti â† spec âˆ¾âŠ¸âŠ tok
  nextSep â† (â‰ -(âŒˆ`âŠ¢Ã—1+â†•âˆ˜â‰ )âŒ¾âŒ½) sep â† 1=tt

  isChr â† 0=tt
  asgn â† ğ•¨ Ã— isChr / ((1Â»1âŠ¸=)âˆ§Â·Â«2âŠ¸=) tt
  c â† isChr / ti
  ord â† â‹ +âŸœ(asgnÃ—âŠâŸœnextSepâŠ¸-) /isChr
  cind â† c {nâ†ğ•©/ğ•¨â‹„(-â‰ n)â†“+`âŒ¾((â‹ğ•¨âˆ¾n)âŠ¸âŠ)ğ•©âˆ¾Â¯1Â¨n}âŒ¾(ordâŠ¸âŠ) asgn
  rplc â† c 0âŠ¸â‰¤â—¶âŸ¨âŠ‘âŸœout,âŠ‘âŸœinitâˆ¾'0'âŠ¸+âˆ¾âŠ‘âŸœpostâŸ©Â¨ cind + câŠitr
  itr +â†© +Â´Â¨ (câˆ¾â‰ in)âŠ”asgn
  "â†"Â¨âŒ¾((1+asgn//isChr)âŠ¸âŠ) rplcâŒ¾(isChrâŠ¸/) tok
}
E_proc â‡ {
  tok â† Tokenize ğ•©
  âˆ¾ (ğ•¨âŠ£1)âŠ¸E_proc_subâŒ¾((" "âŠ¸â‰¢Â¨tok)âŠ¸/) tok
}
