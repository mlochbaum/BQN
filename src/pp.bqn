# Primitive processor
# Used in pr.bqn and ../test/ref.bqn for handling source code with
# primitive redefinitions.
# Defining a primitive shadows previous definitions, so earlier uses
# of the primitive still use the old definition.
# This is handled by using a new name each time it's defined.

âŸ¨chrs, GetReplacementsâŸ© â† â€¢args
nc â† â‰ Â¨chrs

# Scheme for primitive replacement names
init â† (nc/(' 'âˆ¾Â¨1â€¿2/â†‘"_")âˆ¾Â¨"FMD")âˆ¾Â¨('A'+nc+Â´âŠ¸â†‘â¥Š3âˆ¾âŒœâ—‹â†•26)
post â† nc/(2â€¿1/â†‘"_")âˆ¾Â¨' '

# All replacements: input and output
âŸ¨in,outâŸ© â† GetReplacements âŸ¨â¥ŠÂ¨âˆ¾chrs, initâˆ¾Â¨'0'âˆ¾Â¨postâŸ©

# Number of redefinitions so far, minus one
itr â† Â¯1â¥ŠËœâ‰ in

lfâ†@+10
Tokenizeâ†{
  wcâ†"_Â¯.Ï€âˆ"âˆ¾âˆ¾"0aA"+âŸœâ†•Â¨10â€¿26â€¿26             # Word characters

  # Resolve comments and strings
  sâ€¿dâ†/Â¨2â†‘smâ€¿dmâ€¿câ€¿nâ†ğ•©âŠ¸=Â¨"'""#"âˆ¾lf
  gâ†â‹qâ†âˆ¾âŸ¨  sâ‹„Â¯1â†“dâ‹„/câŸ© â‹„qâ†©gâŠq                # Open indices
  eâ† gâŠâˆ¾âŸ¨2+sâ‹„ 1â†“dâ‹„-âŸœÂ»âˆ˜âŠâŸœ(0âˆ¾+`c)âŠ¸//nâˆ¾1âŸ©      # Matching close indices
  Seâ†{(âŠËœğ•¨)Se 1Â¨âŒ¾((ğ•©/ğ•¨)âŠ¸âŠ)ğ•©}âŸ(0=Â¯1âŠ‘âŠ¢)       # Mark reachable openings
  abâ†(â‰ ğ•©)â†‘/â¼â¥Š((â‰ â†‘âˆ¾âŸœâ‰ Se 1âˆ¾0Â¨)qâ‹e)/â‰qâ‰e       # Open/close masks

  kâ†(nâˆ§ab)<Â»(ğ•©='â€¢')âˆ¨(âˆ§âŸœÂ«ğ•©âˆŠwc)âˆ¨â‰ `ab          # Token continuation mask
  (Â¯1+`Â¬k)âŠ”ğ•©
}

E_proc_sub â† {tokâ†ğ•©
  spec â† âŸ¨in, â¥ŠÂ¨lfâˆ¾",â‹„", â¥ŠÂ¨"â†â†©"âŸ©
  tt â† spec (+`â‰ Â¨)âŠ¸â‹ ti â† spec âˆ¾âŠ¸âŠ tok
  nextSep â† âŒŠ`âŒ¾âŒ½ (â‰ -âŠ¢Ã—â‰ -â†•âˆ˜â‰ ) sep â† 1=tt

  ri â† / 0=tt                               # Replacement indices
  asgn â† ğ•¨ Ã— ri âŠ (1Â»sep) âˆ§ Â«2=tt           # and which are assignments
  c â† ri âŠ ti
  ord â† â‹ +âŸœ(asgnÃ—âŠâŸœnextSepâŠ¸-) ri           # Put LHS after RHS
  cinc â† c {nâ†ğ•©/ğ•¨â‹„(-â‰ n)â†“+`âŒ¾((â‹ğ•¨âˆ¾n)âŠ¸âŠ)ğ•©âˆ¾Â¯1Â¨n}âŒ¾(ordâŠ¸âŠ) asgn
  rplc â† c 0âŠ¸â‰¤â—¶âŸ¨âŠ‘âŸœout,âŠ‘âŸœinitâˆ¾'0'âŠ¸+âˆ¾âŠ‘âŸœpostâŸ©Â¨ cinc + câŠitr
  itr +â†© +Â´Â¨ (câˆ¾â‰ in)âŠ”asgn
  "â†"Â¨âŒ¾((1+asgn/ri)âŠ¸âŠ) rplcâŒ¾(riâŠ¸âŠ) tok
}
E_proc â‡ âˆ¾ 1âŠ˜âŠ£ { ğ•¨âŠ¸E_proc_subâŒ¾((" "âŠ¸â‰¢Â¨ğ•©)âŠ¸/) ğ•© } Tokenizeâˆ˜âŠ¢
