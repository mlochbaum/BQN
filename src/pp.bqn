# Primitive processor
# Used in dzref and pr.bqn for handling source code with primitive
# redefinitions.
# Defining a primitive shadows previous definitions, so earlier uses
# of the primitive still use the old definition.
# This is handled by using a new name each time it's defined.

âŸ¨chrs, GetReplacementsâŸ© â† â€¢args
nc â† â‰ Â¨chrs
chr â† âˆ¾chrs

# Initial primitive replacement names
init â† (nc/(' 'âˆ¾Â¨1â€¿2/â†‘"_")âˆ¾Â¨"FMD")âˆ¾Â¨('A'+nc+Â´âŠ¸â†‘â¥Š3âˆ¾âŒœâ—‹â†•26)
post â† nc/(2â€¿1/â†‘"_")âˆ¾Â¨' '
pn â† initâˆ¾Â¨'0'âˆ¾Â¨post

# All replacements: input and output
âŸ¨in,outâŸ© â† GetReplacements âŸ¨â¥ŠÂ¨chr,pnâŸ©

# Make a new name for primitive ğ•©
itr â† Â¯1â¥ŠËœâ‰ chr
Shadow â† {
  iâ†âŠ‘chrâŠğ•©
  nâ†0 â‹„ itrâ†©{nâ†©1+ğ•©}âŒ¾(iâŠ‘âŠ¢)itr
  outâ†©((iâŠ‘init)âˆ¾('0'+n)âˆ¾iâŠ‘post)âŒ¾(iâŠ‘âŠ¢)out
}

# Does the expression define a primitive?
E_isdef â† (3â‰¤â‰ )â—¶âŸ¨0,âˆ§Â´âŸ¨chr," ","â†â†©"âŸ©âˆŠËœÂ¨3âŠ¸â†‘âŸ©
# Process ordinary expression
E_nodef â‡ {
  idChars â† "_Â¯.Ï€âˆ"âˆ¾âˆ¾"0aA"+âŸœâ†•Â¨10â€¿26â€¿26
  qâ†â‰ `ğ•©='"' â‹„ qâˆ¨â†©â‰ `q<ğ•©='''                 # Quotes
  fâ†(ğ•©=@+10)â‰¥â—‹((1+â†•âˆ˜â‰ )âŠ¸(âŒˆ`Ã—))q<ğ•©='#'       # Comments
  t â† (Â¯1+`Â·Â¬(Â»f/q)âˆ¨Â·Â»âŠ¸âˆ§âˆŠâŸœidChars)âŠ¸âŠ” f/ğ•©   # Tokenize
  âˆ¾ (inâŠ¸âŠ âŠ‘âŸœoutâŸ(<âŸœ(â‰ in))Â¨ âŠ¢) t            # Replace
}
# Process expression, possibly redefining a primitive
E_proc â‡ E_isdefâ—¶E_nodefâ€¿{
  tail â† E_proc 3â†“ğ•©                        # RHS
  Shadow âŠ‘ğ•©                                # New name
  (E_proc 1â†‘ğ•©) âˆ¾ "â†" âˆ¾ tail                # LHS
}
