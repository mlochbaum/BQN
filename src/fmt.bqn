# Format an array to a string including newlines
{
  F0â†ğ”½  # Function to format a scalar
  FmtAtom â† (â‰ â‰¤âŸœâˆâ—¶âŸ¨@âŠ¸â‰ â—¶âŸ¨"@","'"âŠ¸(âˆ¾âˆ¾âŠ£)âŸ©,F0âŸ©)

  # Vertical padding for arrays of rank greater than 2
  PadV â† {
    # Leading shape
    ls â† Â¯1â†“â‰¢ğ•©
    # Empty lines after each row: 1 if it's at the end of a 2-cell, plus
    # 1 if it's at the end of a 2-cell and a 3-cell, and so on
    p â† â¥Š +â‰Â¯1â€¿âˆÂ´ Ã—âŒœËœ`âŒ¾âŒ½ (-1âŒˆls)â†‘Â¨1
    # But none at the very end
    p â†© 0âŒ¾(Â¯1âŠ¸âŠ‘) p
    Pad â† {iâ†/1+ğ•¨ â‹„ (Â¯1Â¨âŒ¾((Â¬âˆŠi)âŠ¸/)i) âŠ ğ•©âˆ¾(Â¯1âŠ‘â‰¢ğ•©)â¥Š" "}
    p (âŠ‘0âˆŠls)â—¶âŸ¨Pad,+Â´âŠ¸â†‘âŸ© ((Ã—Â´ls)âˆ¾Â¯1âŠ‘â‰¢ğ•©) â¥Š ğ•©
  }âŸ(2 < =)

  # Horizontal padding: just some spaces on either side
  PadH â† { sâ†âŸ¨â‰ ğ•©,ğ•¨âŸ©â¥Š' ' â‹„ âˆ¾â‰âŸ¨s,ğ•©,sâŸ© }

  Pad â† PadHâŸœPadV

  # Add a frame to padded data
  Enframe â† âˆ¨â—‹(1âŠ¸â‰ )âŸœâ‰ â—¶{âˆ¨Â´2=+`-Ë"âŸ¨âŸ©"=âŒœâŠğ•©}â€¿1â—¶{
    # One-line version
    â‰"âŸ¨"âˆ¾(Â¯1â†“1â†“âŠğ•©)âˆ¾"âŸ©"
  }â€¿{
    # General case
    l â† Â¯1 âŠ‘ â‰¢ğ•©
    âˆ¾ âŸ¨
      â‰lâ†‘âˆ¾âŸ¨"â”Œ",(5âŠ¸<)â—¶âŸ¨â¥Š"Â·â”€"âŠËœ1âŒŠâŠ¢,F0âŸ©ğ•¨âŸ©
      ((4âŒŠ0âŒˆğ•¨-1)âŠ‘"Â·â•µâ•â”†â”Š")âŒ¾âŠ‘ ğ•©
      â‰l-âŠ¸â†‘"â”˜"
    âŸ©
  }

  FmtEmpty â† (0â€¿0â‰¢â‰¢)â—¶("â”Œâ”"â‰"â””â”˜")â€¿(((2â‰ =)âˆ¨0=â‰ )â—¶{
    'â”'âŒ¾(0â€¿Â¯1âŠ¸âŠ‘) 2 Enframe 1 PadH " "Â¨ğ•©
  }â€¿{
    â‰"âŸ¨âŸ©"âˆ¾Ëœ(1<â‰ )â—¶âŸ¨"",'â¥Š'âŒ¾(Â¯1âŠ¸âŠ‘)Â·âˆ¾Â·âˆ¾âŸœ"â€¿"Â¨F0Â¨âŸ©â‰¢ğ•©
  })

  PaddingJoin â† {1 PaddingJoin ğ•©}âŠ˜{
    s â† â‰¢Â¨ ğ•©
    w â† (0<=)â—¶âŸ¨â¥Š,âŒˆËâŸ(=-1Ë™)âŸ©1âŠ‘Â¨s
    h â† âŒˆËâ‰1âŸ(0<=) âŠ‘Â¨s
    âˆ¾â‰2 â‰âŸ(0âŒˆ2-=) (h âˆ¾âŒœ ğ•¨Ã—wÂ¬(-ğ•¨Ã—â‰ w)â†‘1) â†‘Â¨ ğ•©
  }

  FmtMixed â† {
    (=ğ•©) Enframe 2 Pad ğ•¨ PaddingJoin FmtÂ¨ğ•©
  }

  FmtSimple â† (â‰ (0âŠ¸<+â‰¤)+Â´)âˆ˜(â¥Šâ‰¤âˆË™)â—¶{ # Depth 1
    # All characters
    k â† âˆâŸ(0âŠ¸=) -â‰  c â† Â¯1â†“â‰¢ğ•©
    q â† '"'
    # Escape quotes in strings (rank 1) and substitute control chars
    # with control pictures for other ranks.
    CSub â† { ğ•© + (ğ•©(=Ã—'â¡'-âŠ¢)@+127) + ('â€'-@)Ã—ğ•©<@+32 }
    ğ•© â†© (1â‰ =)â—¶âŸ¨(1+q=âŠ¢)âŠ¸/,CsubâŸ© ğ•©
    r â† =ğ•©
    (r Enframe 1 PadH PadV)âŸ(1â‰ r) â‰ (câ†‘q) âˆ¾â‰k ğ•© âˆ¾â‰k c-âŠ¸â†‘q
  }â€¿{
    # Not homogeneous, or empty
    (âˆ¨Â´0=â‰¢)â—¶FmtMixedâ€¿FmtEmpty ğ•©
  }â€¿{
    # All numbers
    Â¯1 FmtMixed ğ•©
  }

  # Format to character matrix
  Fmt â† (2âŒŠâ‰¡)â—¶FmtAtomâ€¿FmtSimpleâ€¿FmtMixed

  # Convert to string
  Â¯1â†“Â·â¥Š âˆ¾âŸœ(@+10)Ë˜âˆ˜Fmt
}
