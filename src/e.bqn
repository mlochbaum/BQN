# Expression explainer: generates an svg diagram to show how a BQN
# program is evaluated

wh â† 10.75â€¿24
padâ† whÃ—2â€¿1
to â† 1+whÃ·2â€¿3
t  â† 10

ps â† At "stroke=currentColor|fill=none|stroke-width=1"
rc â† At "class=code|stroke-width=1|rx=10"
gr â† "g" At "font-family=BQN,monospace|font-size=18px|class=Paren|fill=currentColor"
gt â† "g" At "font-size=15px|text-anchor=middle"
gb â† "g" At "class=codeCover|stroke-width=8|stroke-linejoin=round"
gf â† "g" At "opacity=0.9"
Shadow â† {
  p â† ("text" Attr Â·Pos -âŸœ0â€¿2)Â¨ ğ•¨
  gt Enc âŸ¨gb,gfâŸ© EncÂ¨ (1âŠ¸âŠ‘Â¨ â‰â—‹<â—‹(p EncÂ¨âŠ¢) âˆ¾Â¨) ğ•©
}

hlclâ€¿hlch â† <Ë˜ â‰ âˆ˜â€¿2â¥ŠâŸ¨
  "Number"      , ('0'+â†•10)âˆ¾"Â¯.Ï€âˆ"
  "Paren"       , "()"
  "Bracket"     , "âŸ¨âŸ©"
  "Brace"       , "{}"
  "Nothing"     , "Â·"
  "String"      , "'"âˆ¾'"'âˆ¾"@"
  "Comment"     , "#"
âŸ©
hlcl âˆ¾â†© âŸ¨
  "Gets"      # Â¯3
  "Ligature"  # Â¯2
  "Separator" # Â¯1
  "Value"     #  0
  "Function"  #  1
  "Modifier"  #  2
  "Modifier2" #  3
âŸ©
GetHlclâ†hlch{(+`â‰ Â¨ğ•—)â‹(âˆ¾ğ•—)âŠ¸âŠ}
hlTag â† {"<tspan class='"âˆ¾ğ•©âˆ¾"'>"}Â¨ hlcl

Explain â† {
  bâ€¿constâ€¿blkâ€¿iâ€¿tok â† ğ•¨
  baâ€¿bcâ€¿boâ€¿bp â† '0'-ËœâŸ¨ # For each instruction, number of:
    "11111000000000010000022000"  # Arguments
    "000//232323223102303200121"  # Stack values consumed
    "11111111111111011101111110"  # Stack values output
    "00000110111001001101000100"  # Position determiner
  âŸ©
  m â† { # Mask of instruction starts
    a â† ba(âŠ£âŠËœâ‰ âŠ¸>Ã—âŠ¢)b
    naâ† âˆ¾âŸœâ‰  (â‰ -(1+â†•âˆ˜â‰ )âŠ¸(Â»Â·âŒˆ`Ã—)âŒ¾âŒ½) <âŸœ128 b
    n â† 1+{(ğ•©=âŒœa) +Ëâˆ˜Ã— >âŠâŸœnaâŸğ•©â†•â‰ a}â†•3
    ! âˆ§Â´ â†•âˆ˜â‰ âŠ¸< n
    Seâ†{(âŠËœğ•¨)Se 1Â¨âŒ¾((ğ•©/ğ•¨)âŠ¸âŠ)ğ•©}âŸ(0=Â¯1âŠ‘âŠ¢)
    (â‰ â†‘âˆ¾âŸœâ‰ Se 1âˆ¾0Â¨) n
  }
  mbâ€¿mi â† 0â€¿Â¯1 â†“Â¨ mâŠ¸/Â¨ bâ€¿i
  laâ†Â¯1=naâ†mbâŠbc
  na(bâŠËœ1+âŠ£)âŒ¾(laâŠ¸/)Ëœâ†©/m
  noâ†1âŒ¾(Â¯1âŠ¸âŠ‘)mbâŠbo
  râ†+`no-na
  ! 1=Â¯1âŠ‘r
  dâ†(+`noâŠ¸Ã—)âŠ¸Ã—fâ†0<na
  pâ†((Â¯1â†“r)â‹âŠ¸âŠâ—‹â‹(âŠâŸœr+âŠ’))âŠ¸âŠ/naÂ¬no
  fâ†‘Ëœâ†©â‰ p

  srcâ€¿toksâ€¿ii â† tok {
    tokâ€¿roleâ€¿valâ€¿sâ€¿e â† ğ•¨
    n â† â‰ hlch
    o â† hlTag âŠËœ (n+3+role) (âŠ¢+-Ã—nâŠ¸=) GetHlcl sâŠğ•©
    c â† "</tspan>"Â¨e
    t â† câˆ¾o
    ilf â† /ğ•©=@+10
    ğ•© â†© ((ilfâˆŠs)âŠ" â‹„")âŒ¾(ilfâŠ¸âŠ)ğ•©
    src â† ((â†•â‰ ğ•©)âˆ¾(â‰ Â¨t)/eâˆ¾s-1) â‹âŠ¸âŠ ğ•©âˆ¾âˆ¾t
    ttâ† <Ë˜â‰> âŸ¨o, e(ğ•©âŠËœâŠ¢+â†•âˆ˜Â¬)Â¨s, câŸ©
    tiâ† sâŠ(Â¬f)/mi
    âŸ¨src, tiâŠtt, tiâŠ(s+e)Ã·2âŸ©
  } ğ•©

  jâ†Â¯1â†“((1-Ëœ+`Â¬f)âŠii)âŠËœâŠËœâŸâ‰ {sâ†ğ•©âŠËœgâ†â‹ğ•©â‹„(g/Ëœ(âŠ’s)=sâŠmbâŠbp)âŒ¾((â·s)âŠ¸âŠ)â†•â‰ mb}p
  jeâ†jâˆ¾Â¯1.25
  qâ†(/fâˆ¨jâ‰ pâŠje-la) (âŠâ‰âŠ£) p

  pd â† <âŠ¸âˆ¾âŸœâŒ½Ë˜ËœË q âŠ â‰whÃ—0.6â€¿0.1+jeâ‰d
  dimâ† (whÃ—âŸ¨â‰ ğ•©,2+âŒˆÂ´dâŸ©)+2â€¿0Ã—pad
  (512â€¿0âŠ¸âŒˆâŠ¸(âŠ£âˆ¾Ëœ(t+pad)-Ëœ-ËœÃ·2Ë™)dim+2Ã—t) SVG gr Enc âˆ¾â¥ŠÂ¨âŸ¨
    <"rect" Elt rcâˆ¾(Pos-pad)âˆ¾"width"â€¿"height"â‰Ë˜FmtNumÂ¨dim
    <"text" Enc src
    (<"path" Elt psâˆ¾"d"â‰â—‹<Â·âˆ¾"MVH"âˆ¾âŸœFmtÂ¨âŠ¢)Ë˜ pd
    (ii (to+whÃ—â‰)Â¨âŸœ(âŠâŸœd) (Â¬f)/p) Shadow toks
  âŸ©
}
