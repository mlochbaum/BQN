# Expression explainer: generates an svg diagram to show how a BQN
# program is evaluated

wh â† 10.84â€¿24
padâ† whÃ—2â€¿1
to â† 0â€¿Â¯1+whÃ·2â€¿3
t  â† 10

ps â† At "stroke=currentColor|fill=none|stroke-width=1"
rc â† At "class=code|stroke-width=1|rx=10"
gr â† "g" At "font-family=BQN,monospace|font-size=18px|class=Paren|fill=currentColor"
gt â† "g" At "font-size=15px|text-anchor=middle"
gb â† "g" At "class=codeCover|stroke-width=8|stroke-linejoin=round"
gf â† "g" At "opacity=0.9"

hlclâ€¿hlch â† <Ë˜ â‰ âˆ˜â€¿2â¥ŠâŸ¨
  "Number"      , ('0'+â†•10)âˆ¾"Â¯.Ï€âˆ"
  "Paren"       , "()"
  "Bracket"     , "âŸ¨âŸ©"
  "Brace"       , "{}"
  "Nothing"     , "Â·"
  "String"      , "'"âˆ¾'"'âˆ¾"@"
  "Comment"     , "#"
âŸ©
hlcl âˆ¾â†© âŸ¨
  "Gets"      # Â¯3
  "Ligature"  # Â¯2
  "Separator" # Â¯1
  "Value"     #  0
  "Function"  #  1
  "Modifier"  #  2
  "Modifier2" #  3
âŸ©
GetHlclâ†hlch{(+`â‰ Â¨ğ•—)â‹(âˆ¾ğ•—)âŠ¸âŠ}
hlTag â† {"<tspan class='"âˆ¾ğ•©âˆ¾"'>"}Â¨ hlcl

escchars â† """&<>" â‹„ escapes â† ("&"âˆ¾âˆ¾âŸœ";")Â¨"quot"â€¿"amp"â€¿"lt"â€¿"gt"

Explain â† {
  bâ€¿constâ€¿blkâ€¿bdyâ€¿(iâ€¿e)â€¿tok â† ğ•¨
  baâ€¿bcâ€¿boâ€¿bp â† (âŠ/Â¨1âŠ¸â†“)'0'-ËœâŸ¨ # For each instruction, number of:
    "114113141111111311411413141111=111"  # Codes until next opcode
    "1110001100000000000222110000000111"  # Arguments
    "000111//23232303232000001122232111"  # Stack values consumed
    "1110001111111101111111110101111111"  # Stack values output
    "0000000011111101010000000000010000"  # Position determiner
  âŸ©
  m â† { # Mask of instruction starts
    n â† (â†•â‰ b)+1+ba(âŠ£âŠËœâ‰ âŠ¸>Ã—âŠ¢)b
    Seâ†{(âŠËœğ•¨)Se 1Â¨âŒ¾((ğ•©/ğ•¨)âŠ¸âŠ)ğ•©}âŸ(0=Â¯1âŠ‘âŠ¢)
    (â‰ â†‘âˆ¾âŸœâ‰ Se 1âˆ¾0Â¨) n
  }
  mbâ€¿mi â† 0â€¿Â¯1 â†“Â¨ mâŠ¸/Â¨ bâ€¿i
  laâ†Â¯1=naâ†mbâŠbc
  na(bâŠËœ1+âŠ£)âŒ¾(laâŠ¸/)Ëœâ†©/m
  noâ†1âŒ¾(Â¯1âŠ¸âŠ‘)mbâŠbo
  râ†+`no-na
  ! 1=Â¯1âŠ‘r
  dâ†(+`noâŠ¸Ã—)âŠ¸Ã—fâ†0<na
  pâ†((Â¯1â†“r)â‹âŠ¸âŠâ—‹â‹(âŠâŸœr+âŠ’))âŠ¸âŠ/naÂ¬no
  kâ†pâ‰ âŠ¸â†‘Â¬f

  srcâ€¿toksâ€¿ii â† tok {
    tokâ€¿roleâ€¿valâ€¿sâ€¿e â† ğ•¨
    n â† â‰ hlch
    o â† hlTag âŠËœ (n+3+role) (âŠ¢+-Ã—nâŠ¸=) GetHlcl sâŠğ•©
    c â† "</tspan>"Â¨e
    t â† câˆ¾o
    ilf â† /ğ•©=@+10
    ğ•© â†© ((ilfâˆŠs)âŠ" â‹„")âŒ¾(ilfâŠ¸âŠ)ğ•©
    uâ†/Â¬emâ†esccharsâ‰ âŠ¸>eiâ†esccharsâŠğ•© â‹„ tâˆ¾Ëœâ†©escapesâŠËœem/ei
    ordâ† â‹uâˆ¾(â‰ Â¨t)/(/em)âˆ¾eâˆ¾s-1
    srcâ† ordâŠ(uâŠğ•©)âˆ¾âˆ¾t
    el â† eiâŠ(â‰ Â¨escapes)âˆ¾1
    xe â† (ordâŠ(+Â´el)>â†•âˆ˜â‰ )âŠ¸/src
    tt â† <Ë˜â‰> âŸ¨o, xeâŠ”Ëœel/1-Ëœs(âŠ£Ã—>)â—‹(+`(â‰ ğ•©)â†‘/â¼)1+e, câŸ©
    ti â† sâŠk/mi
    âŸ¨src, tiâŠtt, tiâŠ(s+e)Ã·2âŸ©
  } ğ•©

  jâ†Â¯1â†“((1-Ëœ+`k)âŠii)âŠËœâŠËœâŸâ‰ {sâ†ğ•©âŠËœgâ†â‹ğ•©â‹„(g/Ëœ(âŠ’s)=sâŠmbâŠbp)âŒ¾((â·s)âŠ¸âŠ)â†•â‰ mb}p
  jeâ†jâˆ¾Â¯1.25
  qâ†(/kâ‰¤jâ‰ pâŠje-la) (âŠâ‰âŠ£) p

  pd â† <âˆ˜(âˆ¾"M VH"âˆ¾Â¨âˆ¾âŸœâŒ½)Ë˜ËœË q âŠ FmtNum â‰whÃ—0.5â€¿0.1+jeâ‰d
  tp â† ii ("text" Attr Pos)âˆ˜(to+whÃ—â‰)Â¨ (k/p)âŠd
  dimâ† (whÃ—âŸ¨â‰ ğ•©,2+âŒˆÂ´dâŸ©)+2â€¿0Ã—pad
  (512â€¿0âŠ¸âŒˆâŠ¸(âŠ£âˆ¾Ëœ(t+pad)-Ëœ-ËœÃ·2Ë™)dim+2Ã—t) SVG gr Enc âˆ¾â¥ŠÂ¨âŸ¨
    <"rect" Elt rcâˆ¾(Pos-pad)âˆ¾"width"â€¿"height"â‰Ë˜FmtNum dim
    <"text" Enc src
    ("path" Elt psâˆ¾"d"â‹ˆâŠ¢)Â¨ pd
    gt Enc âŸ¨gb,gfâŸ© EncÂ¨ (1âŠ¸âŠ‘Â¨ â‹ˆâ—‹(tp EncÂ¨âŠ¢) âˆ¾Â¨) toks
  âŸ©
}
