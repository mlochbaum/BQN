#! /usr/bin/env dbqn

# dzaima/BQN block headers have a different format to account for
# multiple bodies, and use variable names instead of counts.
# Rearrange and make up some names so the bytecode can be run.

compile â† â€¢Import "src/c.bqn"
prims â† (â€¢Import "dzref"){ğ”½} "âŸ¨
  +,-,Ã—,Ã·,â‹†,âˆš,âŒŠ,âŒˆ,|,Â¬,âˆ§,âˆ¨,<,>,â‰ ,=,â‰¤,â‰¥,â‰¡,â‰¢,âŠ£,âŠ¢,â¥Š,âˆ¾,â‰,â†‘,â†“,â†•,Â«,Â»,âŒ½,â‰,/,â‹,â’,âŠ,âŠ‘,âŠ,âŠ’,âˆŠ,â·,âŠ”,!
  Ë™,Ëœ,Ë˜,Â¨,âŒœ,â¼,Â´,Ë,`
  âˆ˜,â—‹,âŠ¸,âŸœ,âŒ¾,âŠ˜,â—¶,â‰,âš‡,âŸ
âŸ©"

LEBâ†{
  bâ†128
  sâ†+`Â»iâ†1+lâ†âŒŠbâ‹†â¼1âŒˆğ•©
  oâ†â‹â‹â†•âˆ˜â‰ âŠ¸-i/s
  vâ†oâŠl{fâ†Ã—ğ•¨â‹„(ğ•¨-1)(bâŠ¸(Ã—âŸœf+|)âˆ¾ğ•ŠâŸœ(âŒŠÃ·âŸœb)â—‹(fâŠ¸/))âŸ(âˆ¨Â´f)ğ•©}ğ•©
  vâ€¿sâ€¿i
}

specialâ†<Ë˜âˆ˜â€¿2â¥Š"ğ•¤ğ•©ğ•¨ğ•£ğ•—ğ•˜"
DCompileâ‡{
  âŸ¨bc,o,fblk,indâŸ© â† 4 â†‘ prims Compile ğ•©
  bclâ€¿elâ€¿olâ†LEB bc
  blkâ€¿bdy â† <Ë˜â‰>(â†•â‰ fblk){
    âŸ¨t,i,l,nâŸ©â†ğ•©
    sâ†(3Ã—i)â†“(tâŠ‘3â€¿5â€¿6)â†‘special
    âŸ¨âŸ¨t,i,ğ•¨,ğ•¨âŸ© â‹„ âŸ¨lâŠ‘el, sâˆ¾â¥ŠÂ¨'a'+â†•n-â‰ sâŸ©âŸ©
  }Â¨fblk
  âŸ¨bcl,o,blk,bdy,ol/âŠ‘ind,ol/1âŠ‘ind,ğ•©âŸ©
}
DRunâ‡â€¢COMPâˆ˜DCompile
