#!/usr/bin/env dbqn

# Compile and run the primitive implementations, and prim.bqn

impl â† â€¢LNS â€¢pathâˆ¾"../src/r.bqn"

drun â† â€¢EX â€¢pathâˆ¾"../dc.bqn"

chrsâ†âŸ¨
  "!+-Ã—Ã·â‹†âˆšâŒŠâŒˆâˆ§âˆ¨Â¬|=â‰ â‰¤<>â‰¥â‰¡â‰¢âŠ£âŠ¢â¥Šâˆ¾â‰â†‘â†“â†•Â«Â»âŒ½â‰/â‹â’âŠâŠ‘âŠâŠ’âˆŠâ·âŠ”"
  "Ë™ËœË˜Â¨âŒœâ¼Â´Ë`"
  "âˆ˜âŠ¸âŸœâ—‹âŒ¾â‰âš‡âŸâ—¶âŠ˜"
âŸ©
nc â† â‰ Â¨chrs
chr â† âˆ¾chrs
itr â† 0â¥ŠËœâ‰ chr

init â† " "âŠ¸âˆ¾Â¨(/âŸœ"_"Â¨nc/0â€¿1â€¿1)âˆ¾Â¨(nc/"FMD")âˆ¾Â¨(nc+Â´âŠ¸â†‘â¥Š"ABC"âˆ¾âŒœâ€¢a)
post â† âˆ¾âŸœ" "Â¨/âŸœ"_"Â¨nc/0â€¿0â€¿1
names â† initâˆ¾Â¨'0'âˆ¾Â¨post

Inc â† {
  iâ†âŠ‘chrâŠğ•©
  nâ†0 â‹„ itrâ†©{nâ†©1+ğ•©}âŒ¾(iâŠ‘âŠ¢)itr
  namesâ†©((iâŠ‘init)âˆ¾('0'+n)âˆ¾iâŠ‘post)âŒ¾(iâŠ‘âŠ¢)names
}

# built-in assumptions
Mod â† {((âŠ‘chrâŠğ•¨)âŠ‘names) âˆ¾ " â† " âˆ¾ ğ•©}

pre â† âŸ¨
  "IsArray â† 0â‰ â‰¡"
  "Type    â† âŠ‘âŸ¨âŸ©â¥Š0âŠ¸â¥Š"
  "Log     â† â‹†â¼"
  "GroupLenâ† â‰ Â¨âŠ”"
  "GroupOrdâ† âˆ¾âŠ”âˆ˜âŠ¢"
  '!' Mod "{ğ•© â‹„ â‰¤1}âŸ(1â‰¢âŠ¢)"
âŸ©âˆ¾ModâŸœâ¥ŠÂ¨ "+-Ã—Ã·â‹†âŒŠ=â‰¤â‰¢â¥ŠâŠ‘â†•âŒœ`âŠ˜"


# checks if line is a builtin redefinition
E_isdef â† (3â‰¤â‰ )â—¶âŸ¨0,âˆ§Â´âŸ¨chr," ","â†â†©"âŸ©âˆŠËœÂ¨3âŠ¸â†‘âŸ©

# removes comments and replaces built-ins with names
E_proc â† {
  lâ†â‰ chr
  qâ†â‰ `ğ•©='"' â‹„ qâˆ¨â†©â‰ `q<ğ•©=''' â‹„ fâ†Â¬âˆ¨`q<ğ•©='#'
  âˆ¾ (((lÃ—f/q)+chrâŠ¸âŠ) (â‰¥âŸœl)â—¶âŸ¨âŠ‘âŸœnames,â¥Šâˆ˜âŠ¢âŸ©Â¨ âŠ¢) f/ğ•©
}

E_redef â† { # handles [fmd] [â†â†©]
  tail â† E_proc 3â†“ğ•© # must use old def
  Inc âŠ‘ğ•©
  (E_proc 1â†‘ğ•©) âˆ¾ "â†" âˆ¾ tail
}

pre âˆ¾â†© E_isdefâ—¶E_procâ€¿E_redefÂ¨ impl
t â† (Â¬âˆ˜âŠ‘':'âˆŠâŠ¢)Â¨âŠ¸/ 3âŠ¸â†“âŒ¾(3âŠ¸âŠ‘) â€¢LNS â€¢pathâˆ¾"prim.bqn"
res â† DRun âˆ¾ âˆ¾âŸœ(@+10)Â¨ pre âˆ¾ E_procÂ¨ t
â€¢ â† ("All "âˆ¾(â•â‰ res)âˆ¾" passed!")âŸ(0=â‰ ) /res
