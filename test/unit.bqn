#! /usr/bin/env bqn

# Tests for components of BQN: compiler, runtime, primitive spec

filesâ€¿opts â† 2 â†‘ ('-'=âŠ‘)Â¨âŠ¸âŠ” â€¢args
files â†© (0<â‰ )â—¶âŸ¨1,âˆ¨Â´"all"âŠ¸â‰¡Â¨âŸ©â—¶âŸ¨âˆ¾âŸœ".bqn"Â¨, â€¢file.Listâˆ˜"cases"âŸ© files
ncâ€¿rtâ€¿refâ€¿noerr â† "-nocomp"â€¿"-rt"â€¿"-ref"â€¿"-noerr" âˆŠ opts
"Can't test runtime without the compiler!" ! Â¬ncâˆ§rtâˆ¨ref

Native â† â€¢BQN
ReBQN â† {ğ•Š rt:
  compile â† (â€¢Import "../src/glyphs.bqn") â€¢Import "../src/c.bqn"
  vm â† â€¢Import "../vm.bqn"
  BQN â† âŸ¨rt,{ğ•Š"bqn":BQN}Â¨âŸ©âŠ¸(VM Compile)
}
exec â† ((rtâŒˆ2Ã—ref)Â¬nc)â—¶âŸ¨
  NativeË™                                          # Native
  {ğ•¤â‹„ ReBQN â€¢BQNâˆ˜â¥ŠÂ¨ âˆ¾â€¢Import "../src/glyphs.bqn"}  # Compiled; native runtime
  {ğ•¤â‹„ ReBQN â€¢Import "../rt.bqn"}                   # Self-hosted
  {ğ•¤â‹„ ReBQN â€¢Import "ref.bqn"}                     # Reference implementations
âŸ© @

c â† âˆ¾ ((0<â‰ )â—¶0â€¿('#'â‰ âŠ‘)Â¨âŠ¸/ Â· â€¢file.Lines "cases/"âŠ¸âˆ¾)Â¨ files
c â†© ('!'â‰ âŠ‘)Â¨âŠ¸/âŸnoerr c
â€¢Out 1â†“âˆ¾' 'âŠ¸âˆ¾Â¨âˆ¾âŸ¨
  âŸ¨"Running",â€¢Reprâ‰ c,"tests:"âŸ©
  noerr/âŸ¨"(error cases excluded)"âŸ©
  Â¯4â†“Â¨files
âŸ©

Trim â† ((âˆ¨`âˆ§âˆ¨`âŒ¾âŒ½)' 'âŠ¸â‰ )âŠ¸/
M â† {eâ€¿bâ†ğ•©
  Msg â† {âˆ¾âŸ¨
    """",b,""": expected "
    "to fail"âŸ("!"âŠ¸â‰¡)e
    " but "
    0âŠ¸â‰¡â—¶âŸ¨"received "âˆ¾Â·â€¢ReprâŠ"{â€¦}"âŠ‘,"evaluation failed"âŸ©ğ•©
  âŸ©}
  ("!"âŠ¸â‰¡â—¶âŸ¨<Native,0Ë™âŸ© e) â‰¢â—¶âŸ¨0,1âˆ˜â€¢Outâˆ˜MsgâŸ© <âˆ˜ExecâŠ0 b
}
r â† (M '%'âŠ¸= (âˆ¨Â´âŠ£)â—¶âŸ¨"1"â‰â—‹<âŠ¢, TrimÂ¨(+`-2âŠ¸Ã—)âŠ¸âŠ”âŸ© âŠ¢)Â¨ c
â€¢Out 0âŠ¸<â—¶âŸ¨"All passed!",â€¢Reprâˆ¾" failed!"Ë™âŸ© +Â´r
